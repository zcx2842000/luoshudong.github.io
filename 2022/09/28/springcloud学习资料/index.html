<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="springcloud学习资料, Hexo">
    <meta name="description" content="[TOC]
springcloud五大常用组件：Eureka、Ribbon、Hystrix、Feign、Zuul、Config、Bus、Stream、Sleuth（跟踪）、Shiro
Bus:先安装erLang，在安装rabbitMQ；
P">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>springcloud学习资料 | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">springcloud学习资料</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">No tag</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-09-28
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>[TOC]</p>
<p>springcloud五大常用组件：Eureka、Ribbon、Hystrix、Feign、Zuul、Config、Bus、Stream、Sleuth（跟踪）、Shiro</p>
<p>Bus:先安装erLang，在安装rabbitMQ；</p>
<p>POM文件标签引用 直接 ${标签名}即可</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20201128100128926.png" alt="image-20201128100128926"></p>
<p>远程仓库：<a target="_blank" rel="noopener" href="https://github.com/zcx2842000/springcloud-config.git">https://github.com/zcx2842000/springcloud-config.git</a></p>
<h1 id="SpringCloud教程第1篇：Eureka（F版本）"><a href="#SpringCloud教程第1篇：Eureka（F版本）" class="headerlink" title="SpringCloud教程第1篇：Eureka（F版本）"></a>SpringCloud教程第1篇：Eureka（F版本）</h1><p> 2018&#x2F;08&#x2F;01</p>
<h2 id="一、spring-cloud简介"><a href="#一、spring-cloud简介" class="headerlink" title="一、spring cloud简介"></a>一、spring cloud简介</h2><p>鉴于《史上最简单的Spring Cloud教程》很受读者欢迎，再次我特意升级了一下版本，目前支持的版本为Spring Boot版本2.0.3.RELEASE,Spring Cloud版本为Finchley.RELEASE。</p>
<p>Finchley版本的官方文档如下： <a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<p>spring cloud 为开发人员提供了快速构建分布式系统的一些工具，包括配置管理、服务发现、断路器、路由、微代理、事件总线、全局锁、决策竞选、分布式会话等等。它运行环境简单，可以在开发人员的电脑上跑。另外说明spring cloud是基于springboot的，所以需要开发中对springboot有一定的了解，如果不了解的话可以看这篇文章：<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/61472783">2小时学会springboot</a>。另外对于“微服务架构” 不了解的话，可以通过搜索引擎搜索“微服务架构”了解下。</p>
<h2 id="二、创建服务注册中心"><a href="#二、创建服务注册中心" class="headerlink" title="二、创建服务注册中心"></a>二、创建服务注册中心</h2><p>在这里，我还是采用Eureka作为服务注册与发现的组件，至于Consul 之后会出文章详细介绍。</p>
<p><strong>2.1 首先创建一个maven主工程。</strong></p>
<p>首先创建一个主Maven工程，在其pom文件引入依赖，spring Boot版本为2.0.3.RELEASE，Spring Cloud版本为Finchley.RELEASE。这个pom文件作为父pom文件，起到依赖版本控制的作用，其他module工程继承该pom。这一系列文章全部采用这种模式，其他文章的pom跟这个pom一样。再次说明一下，以后不再重复引入。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sc-f-chapter1&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;sc-f-chapter1&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.3.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;eureka-server&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;service-hi&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>**2.2 然后创建2个model工程:**一个model工程作为服务注册中心，即Eureka Server,另一个作为Eureka Client。</p>
<p>下面以创建server为例子，详细说明创建过程：</p>
<p>右键工程-&gt;创建model-&gt; 选择spring initialir 如下图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-de33b84a79858106.png" alt="Paste_Image.png"></p>
<p>下一步-&gt;选择cloud discovery-&gt;eureka server ,然后一直下一步就行了。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-3addb73d569a58e6.png" alt="Paste_Image.png"></p>
<p>创建完后的工程，其pom.xml继承了父pom文件，并引入spring-cloud-starter-netflix-eureka-server的依赖，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;eureka-server&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;eureka-server&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sc-f-chapter1&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p><strong>2.3 启动一个服务注册中心</strong>，只需要一个注解@EnableEurekaServer，这个注解需要在springboot工程的启动application类上加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaServer</span><br><span class="line">public class EurekaServerApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( EurekaServerApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**2.4 **eureka是一个高可用的组件，它没有后端缓存，每一个实例注册之后需要向注册中心发送心跳（因此可以在内存中完成），在默认情况下erureka server也是一个eureka client ,必须要指定一个 server。eureka server的配置文件appication.yml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">  client:</span><br><span class="line">    registerWithEureka: false</span><br><span class="line">    fetchRegistry: false</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: eurka-server</span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<p>通过eureka.client.registerWithEureka：false和fetchRegistry：false来表明自己是一个eureka server.</p>
<p><strong>2.5</strong> eureka server 是有界面的，启动工程,打开浏览器访问： <a target="_blank" rel="noopener" href="http://localhost:8761/">http://localhost:8761</a> ,界面如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-8c954deeb3a3a01c.png" alt="Paste_Image.png"></p>
<blockquote>
<p>No application available 没有服务被发现 ……^_^ 因为没有注册服务当然不可能有服务被发现了。</p>
</blockquote>
<h2 id="三、创建一个服务提供者-eureka-client"><a href="#三、创建一个服务提供者-eureka-client" class="headerlink" title="三、创建一个服务提供者 (eureka client)"></a>三、创建一个服务提供者 (eureka client)</h2><p>当client向server注册时，它会提供一些元数据，例如主机和端口，URL，主页等。Eureka server 从每个client实例接收心跳消息。 如果心跳超时，则通常将该实例从注册server中删除。</p>
<p>创建过程同server类似,创建完pom.xml如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;service-hi&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;service-hi&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sc-f-chapter1&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>通过注解@EnableEurekaClient 表明自己是一个eurekaclient.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@RestController</span><br><span class="line">public class ServiceHiApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceHiApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;server.port&#125;&quot;)</span><br><span class="line">    String port;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/hi&quot;)</span><br><span class="line">    public String home(@RequestParam(value = &quot;name&quot;, defaultValue = &quot;forezp&quot;) String name) &#123;</span><br><span class="line">        return &quot;hi &quot; + name + &quot; ,i am from port:&quot; + port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仅仅@EnableEurekaClient是不够的，还需要在配置文件中注明自己的服务注册中心的地址，application.yml配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8762</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-hi</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br></pre></td></tr></table></figure>

<p>需要指明spring.application.name,这个很重要，这在以后的服务与服务之间相互调用一般都是根据这个name 。 启动工程，打开<a target="_blank" rel="noopener" href="http://localhost:8761/">http://localhost:8761</a> ，即eureka server 的网址：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-d830f93f1e56f6a2.png" alt="Paste_Image.png"></p>
<p>你会发现一个服务已经注册在服务中了，服务名为SERVICE-HI ,端口为7862</p>
<p>这时打开 <a target="_blank" rel="noopener" href="http://localhost:8762/hi?name=forezp">http://localhost:8762/hi?name=forezp</a> ，你会在浏览器上看到 :</p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>源码下载：<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter1">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter1</a></p>
<h2 id="四、参考资料"><a href="#四、参考资料" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69696915">http://blog.csdn.net/forezp/article/details/69696915</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/01/sc-f1-eureka.html">https://www.fangzhipeng.com/springcloud/2018/08/01/sc-f1-eureka.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<h1 id="SpringCloud教程第2篇：Ribbon-F版本"><a href="#SpringCloud教程第2篇：Ribbon-F版本" class="headerlink" title="SpringCloud教程第2篇：Ribbon(F版本)"></a>SpringCloud教程第2篇：Ribbon(F版本)</h1><p> 2018&#x2F;08&#x2F;02</p>
<p>在上一篇文章，讲了服务的注册和发现。在微服务架构中，业务都会被拆分成一个独立的服务，服务与服务的通讯是基于http restful的。Spring cloud有两种服务调用方式，一种是ribbon+restTemplate，另一种是feign。在这一篇文章首先讲解下基于ribbon+rest。</p>
<h2 id="一、ribbon简介"><a href="#一、ribbon简介" class="headerlink" title="一、ribbon简介"></a>一、ribbon简介</h2><blockquote>
<p>Ribbon is a client side load balancer which gives you a lot of control over the behaviour of HTTP and TCP clients. Feign already uses Ribbon, so if you are using @FeignClient then this section also applies.</p>
<p>—–摘自官网</p>
</blockquote>
<p>ribbon是一个负载均衡客户端，可以很好的控制htt和tcp的一些行为。Feign默认集成了ribbon。</p>
<p>ribbon 已经默认实现了这些配置bean：</p>
<ul>
<li>IClientConfig ribbonClientConfig: DefaultClientConfigImpl</li>
<li>IRule ribbonRule: ZoneAvoidanceRule</li>
<li>IPing ribbonPing: NoOpPing</li>
<li>ServerList ribbonServerList: ConfigurationBasedServerList</li>
<li>ServerListFilter ribbonServerListFilter: ZonePreferenceServerListFilter</li>
<li>ILoadBalancer ribbonLoadBalancer: ZoneAwareLoadBalancer</li>
</ul>
<h2 id="二、准备工作"><a href="#二、准备工作" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>这一篇文章基于上一篇文章的工程，启动eureka-server 工程；启动service-hi工程，它的端口为8762；将service-hi的配置文件的端口改为8763,并启动，这时你会发现：service-hi在eureka-server注册了2个实例，这就相当于一个小的集群。</p>
<p>如何在idea下启动多个实例，请参照这篇文章： <a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/76408139">https://blog.csdn.net/forezp/article/details/76408139</a></p>
<p>访问localhost:8761如图所示： 如何一个工程启动多个实例，请看这篇文章:<a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/76408139">https://blog.csdn.net/forezp/article/details/76408139</a></p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-862f68c48735d126.png" alt="img"></p>
<h2 id="三、建一个服务消费者"><a href="#三、建一个服务消费者" class="headerlink" title="三、建一个服务消费者"></a>三、建一个服务消费者</h2><p>重新新建一个spring-boot工程，取名为：service-ribbon; 在它的pom.xml继承了父pom文件，并引入了以下依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;service-ribbon&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;service-ribbon&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sc-f-chapter2&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在工程的配置文件指定服务的注册中心地址为<a target="_blank" rel="noopener" href="http://localhost:8761/eureka/%EF%BC%8C%E7%A8%8B%E5%BA%8F%E5%90%8D%E7%A7%B0%E4%B8%BA">http://localhost:8761/eureka/，程序名称为</a> service-ribbon，程序端口为8764。配置文件application.yml如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br><span class="line">server:</span><br><span class="line">  port: 8764</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-ribbon</span><br></pre></td></tr></table></figure>

<p>在工程的启动类中,通过@EnableDiscoveryClient向服务中心注册；并且向程序的ioc注入一个bean: restTemplate;并通过@LoadBalanced注解表明这个restRemplate开启负载均衡的功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ServiceRibbonApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceRibbonApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @LoadBalanced</span><br><span class="line">    RestTemplate restTemplate() &#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一个测试类HelloService，通过之前注入ioc容器的restTemplate来消费service-hi服务的“&#x2F;hi”接口，在这里我们直接用的程序名替代了具体的url地址，在ribbon中它会根据服务名来选择具体的服务实例，根据服务实例在请求的时候会用具体的url替换掉服务名，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class HelloService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    public String hiService(String name) &#123;</span><br><span class="line">        return restTemplate.getForObject(&quot;http://SERVICE-HI/hi?name=&quot;+name,String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一个controller，在controller中用调用HelloService 的方法，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloControler &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    HelloService helloService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/hi&quot;)</span><br><span class="line">    public String hi(@RequestParam String name) &#123;</span><br><span class="line">        return helloService.hiService( name );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在浏览器上多次访问<a target="_blank" rel="noopener" href="http://localhost:8764/hi?name=forezp%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BA%A4%E6%9B%BF%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8764/hi?name=forezp，浏览器交替显示：</a></p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
<p>hi forezp,i am from port:8763</p>
</blockquote>
<p>这说明当我们通过调用restTemplate.getForObject(“<a target="_blank" rel="noopener" href="http://service-hi/hi?name=%E2%80%9D+name,String.class)%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C%E5%B7%B2%E7%BB%8F%E5%81%9A%E4%BA%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%8C%E8%AE%BF%E9%97%AE%E4%BA%86%E4%B8%8D%E5%90%8C%E7%9A%84%E7%AB%AF%E5%8F%A3%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E3%80%82">http://SERVICE-HI/hi?name=”+name,String.class)方法时，已经做了负载均衡，访问了不同的端口的服务实例。</a></p>
<h2 id="四、此时的架构"><a href="#四、此时的架构" class="headerlink" title="四、此时的架构"></a>四、此时的架构</h2><p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-9f10b702188a129d.png" alt="此时架构图.png"></p>
<ul>
<li>一个服务注册中心，eureka server,端口为8761</li>
<li>service-hi工程跑了两个实例，端口分别为8762,8763，分别向服务注册中心注册</li>
<li>sercvice-ribbon端口为8764,向服务注册中心注册</li>
<li>当sercvice-ribbon通过restTemplate调用service-hi的hi接口时，因为用ribbon进行了负载均衡，会轮流的调用service-hi：8762和8763 两个端口的hi接口；</li>
</ul>
<p>源码下载：<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter2">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter2</a></p>
<h2 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p>本文参考了以下：</p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69788938">http://blog.csdn.net/forezp/article/details/69788938</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/02/sc-f2-ribbon.html">https://www.fangzhipeng.com/springcloud/2018/08/02/sc-f2-ribbon.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<h1 id="SpringCloud教程第3篇：feign（F版本）"><a href="#SpringCloud教程第3篇：feign（F版本）" class="headerlink" title="SpringCloud教程第3篇：feign（F版本）"></a>SpringCloud教程第3篇：feign（F版本）</h1><p> 2018&#x2F;08&#x2F;03</p>
<p>上一篇文章，讲述了如何通过RestTemplate+Ribbon去消费服务，这篇文章主要讲述如何通过Feign去消费服务。</p>
<h2 id="一、Feign简介"><a href="#一、Feign简介" class="headerlink" title="一、Feign简介"></a>一、Feign简介</h2><p>Feign是一个声明式的伪Http客户端，它使得写Http客户端变得更简单。使用Feign，只需要创建一个接口并注解。它具有可插拔的注解特性，可使用Feign 注解和JAX-RS注解。Feign支持可插拔的编码器和解码器。Feign默认集成了Ribbon，并和Eureka结合，默认实现了负载均衡的效果。</p>
<p>简而言之：</p>
<ul>
<li>Feign 采用的是基于接口的注解</li>
<li>Feign 整合了ribbon，具有负载均衡的能力</li>
<li>整合了Hystrix，具有熔断的能力</li>
</ul>
<h2 id="二、准备工作-1"><a href="#二、准备工作-1" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>继续用上一节的工程， 启动eureka-server，端口为8761; 启动service-hi 两次，端口分别为8762 、8773.</p>
<h2 id="三、创建一个feign的服务"><a href="#三、创建一个feign的服务" class="headerlink" title="三、创建一个feign的服务"></a>三、创建一个feign的服务</h2><p>新建一个spring-boot工程，取名为serice-feign，在它的pom文件引入Feign的起步依赖spring-cloud-starter-feign、Eureka的起步依赖spring-cloud-starter-netflix-eureka-client、Web的起步依赖spring-boot-starter-web，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;service-feign&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;service-feign&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sc-f-chapter3&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在工程的配置文件application.yml文件，指定程序名为service-feign，端口号为8765，服务注册地址为<a target="_blank" rel="noopener" href="http://localhost:8761/eureka/">http://localhost:8761/eureka/</a> ，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br><span class="line">server:</span><br><span class="line">  port: 8765</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-feign</span><br></pre></td></tr></table></figure>

<p>在程序的启动类ServiceFeignApplication ，加上@EnableFeignClients注解开启Feign的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableFeignClients</span><br><span class="line">public class ServiceFeignApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceFeignApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一个feign接口，通过@ FeignClient（“服务名”），来指定调用哪个服务。比如在代码中调用了service-hi服务的“&#x2F;hi”接口，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(value = &quot;service-hi&quot;)</span><br><span class="line">public interface SchedualServiceHi &#123;</span><br><span class="line">    @RequestMapping(value = &quot;/hi&quot;,method = RequestMethod.GET)</span><br><span class="line">    String sayHiFromClientOne(@RequestParam(value = &quot;name&quot;) String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Web层的controller层，对外暴露一个”&#x2F;hi”的API接口，通过上面定义的Feign客户端SchedualServiceHi 来消费服务。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HiController &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //编译器报错，无视。 因为这个Bean是在程序启动的时候注入的，编译器感知不到，所以报错。</span><br><span class="line">    @Autowired</span><br><span class="line">    SchedualServiceHi schedualServiceHi;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/hi&quot;)</span><br><span class="line">    public String sayHi(@RequestParam String name) &#123;</span><br><span class="line">        return schedualServiceHi.sayHiFromClientOne( name );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动程序，多次访问<a target="_blank" rel="noopener" href="http://localhost:8765/hi?name=forezp,%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BA%A4%E6%9B%BF%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8765/hi?name=forezp,浏览器交替显示：</a></p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
<p>hi forezp,i am from port:8763</p>
</blockquote>
<p>Feign源码解析：<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/73480304">http://blog.csdn.net/forezp/article/details/73480304</a></p>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter3">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter3</a></p>
<h2 id="五、参考资料-1"><a href="#五、参考资料-1" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p>本文参考了以下：</p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69808079">http://blog.csdn.net/forezp/article/details/69808079</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/03/sc-f3-feign.html">https://www.fangzhipeng.com/springcloud/2018/08/03/sc-f3-feign.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory"><a href="#Post-Directory" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、Feign简介</li>
<li>二、准备工作</li>
<li>三、创建一个feign的服务</li>
<li>五、参考资料</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第4篇：Hystrix（F版本）"><a href="#SpringCloud教程第4篇：Hystrix（F版本）" class="headerlink" title="SpringCloud教程第4篇：Hystrix（F版本）"></a>SpringCloud教程第4篇：Hystrix（F版本）</h1><p> 2018&#x2F;08&#x2F;04</p>
<p>在微服务架构中，根据业务来拆分成一个个的服务，服务与服务之间可以相互调用（RPC），在Spring Cloud可以用RestTemplate+Ribbon和Feign来调用。为了保证其高可用，单个服务通常会集群部署。由于网络原因或者自身的原因，服务并不能保证100%可用，如果单个服务出现问题，调用这个服务就会出现线程阻塞，此时若有大量的请求涌入，Servlet容器的线程资源会被消耗完毕，导致服务瘫痪。服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，这就是服务故障的“雪崩”效应。</p>
<p>为了解决这个问题，业界提出了断路器模型。</p>
<h2 id="一、断路器简介"><a href="#一、断路器简介" class="headerlink" title="一、断路器简介"></a>一、断路器简介</h2><blockquote>
<p>Netflix has created a library called Hystrix that implements the circuit breaker pattern. In a microservice architecture it is common to have multiple layers of service calls.</p>
<p>. —-摘自官网</p>
</blockquote>
<p>Netflix开源了Hystrix组件，实现了断路器模式，SpringCloud对这一组件进行了整合。 在微服务架构中，一个请求需要调用多个服务是非常常见的，如下图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-08d8d524c312c27d.png" alt="HystrixGraph.png"></p>
<p>较底层的服务如果出现故障，会导致连锁故障。当对特定的服务的调用的不可用达到一个阀值（Hystric 是5秒20次） 断路器将会被打开。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-8dcb1f208d62046f.png" alt="HystrixFallback.png"></p>
<p>断路打开后，可用避免连锁故障，fallback方法可以直接返回一个固定值。</p>
<h2 id="二、准备工作-2"><a href="#二、准备工作-2" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>这篇文章基于上一篇文章的工程，首先启动上一篇文章的工程，启动eureka-server 工程；启动service-hi工程，它的端口为8762。</p>
<h2 id="三、在ribbon使用断路器"><a href="#三、在ribbon使用断路器" class="headerlink" title="三、在ribbon使用断路器"></a>三、在ribbon使用断路器</h2><p>改造serice-ribbon 工程的代码，首先在pox.xml文件中加入spring-cloud-starter-netflix-hystrix的起步依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在程序的启动类ServiceRibbonApplication 加@EnableHystrix注解开启Hystrix：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableHystrix</span><br><span class="line">public class ServiceRibbonApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceRibbonApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @LoadBalanced</span><br><span class="line">    RestTemplate restTemplate() &#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改造HelloService类，在hiService方法上加上@HystrixCommand注解。该注解对该方法创建了熔断器的功能，并指定了fallbackMethod熔断方法，熔断方法直接返回了一个字符串，字符串为”hi,”+name+”,sorry,error!”，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class HelloService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    @HystrixCommand(fallbackMethod = &quot;hiError&quot;)</span><br><span class="line">    public String hiService(String name) &#123;</span><br><span class="line">        return restTemplate.getForObject(&quot;http://SERVICE-HI/hi?name=&quot;+name,String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String hiError(String name) &#123;</span><br><span class="line">        return &quot;hi,&quot;+name+&quot;,sorry,error!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动：service-ribbon 工程，当我们访问<a target="_blank" rel="noopener" href="http://localhost:8764/hi?name=forezp,%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8764/hi?name=forezp,浏览器显示：</a></p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>此时关闭 service-hi 工程，当我们再访问<a target="_blank" rel="noopener" href="http://localhost:8764/hi?name=forezp%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%9A%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8764/hi?name=forezp，浏览器会显示：</a></p>
<blockquote>
<p>hi ,forezp,orry,error!</p>
</blockquote>
<p>这就说明当 service-hi 工程不可用的时候，service-ribbon调用 service-hi的API接口时，会执行快速失败，直接返回一组字符串，而不是等待响应超时，这很好的控制了容器的线程阻塞。</p>
<h2 id="四、Feign中使用断路器"><a href="#四、Feign中使用断路器" class="headerlink" title="四、Feign中使用断路器"></a>四、Feign中使用断路器</h2><p>Feign是自带断路器的，在D版本的Spring Cloud之后，它没有默认打开。需要在配置文件中配置打开它，在配置文件加以下代码：</p>
<blockquote>
<p>feign.hystrix.enabled&#x3D;true</p>
</blockquote>
<p>基于service-feign工程进行改造，只需要在FeignClient的SchedualServiceHi接口的注解中加上fallback的指定类就行了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(value = &quot;service-hi&quot;,fallback = SchedualServiceHiHystric.class)</span><br><span class="line">public interface SchedualServiceHi &#123;</span><br><span class="line">    @RequestMapping(value = &quot;/hi&quot;,method = RequestMethod.GET)</span><br><span class="line">    String sayHiFromClientOne(@RequestParam(value = &quot;name&quot;) String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SchedualServiceHiHystric需要实现SchedualServiceHi 接口，并注入到Ioc容器中，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class SchedualServiceHiHystric implements SchedualServiceHi &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String sayHiFromClientOne(String name) &#123;</span><br><span class="line">        return &quot;sorry &quot;+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动四servcie-feign工程，浏览器打开<a target="_blank" rel="noopener" href="http://localhost:8765/hi?name=forezp,%E6%B3%A8%E6%84%8F%E6%AD%A4%E6%97%B6service-hi%E5%B7%A5%E7%A8%8B%E6%B2%A1%E6%9C%89%E5%90%AF%E5%8A%A8%EF%BC%8C%E7%BD%91%E9%A1%B5%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8765/hi?name=forezp,注意此时service-hi工程没有启动，网页显示：</a></p>
<blockquote>
<p>sorry forezp</p>
</blockquote>
<p>打开service-hi工程，再次访问，浏览器显示：</p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>这证明断路器起到作用了。</p>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter4">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter4</a></p>
<h2 id="六、参考资料"><a href="#六、参考资料" class="headerlink" title="六、参考资料"></a>六、参考资料</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69934399">http://blog.csdn.net/forezp/article/details/69934399</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/04/sc-f4-hystrix.html">https://www.fangzhipeng.com/springcloud/2018/08/04/sc-f4-hystrix.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-1"><a href="#Post-Directory-1" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、断路器简介</li>
<li>二、准备工作</li>
<li>三、在ribbon使用断路器</li>
<li>四、Feign中使用断路器</li>
<li>六、参考资料</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第5篇：Zuul（F版本）"><a href="#SpringCloud教程第5篇：Zuul（F版本）" class="headerlink" title="SpringCloud教程第5篇：Zuul（F版本）"></a>SpringCloud教程第5篇：Zuul（F版本）</h1><p> 2018&#x2F;08&#x2F;05</p>
<p>在微服务架构中，需要几个基础的服务治理组件，包括服务注册与发现、服务消费、负载均衡、断路器、智能路由、配置管理等，由这几个基础组件相互协作，共同组建了一个简单的微服务系统。一个简答的微服务系统如下图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-6b7c148110ebc56e.png" alt="Azure (1).png"><strong>注意：A服务和B服务是可以相互调用的，作图的时候忘记了。并且配置服务也是注册到服务注册中心的。</strong> 在Spring Cloud微服务系统中，一种常见的负载均衡方式是，客户端的请求首先经过负载均衡（zuul、Ngnix），再到达服务网关（zuul集群），然后再到具体的服。，服务统一注册到高可用的服务注册中心集群，服务的所有的配置文件由配置服务管理（下一篇文章讲述），配置服务的配置文件放在git仓库，方便开发人员随时改配置。</p>
<h2 id="一、Zuul简介"><a href="#一、Zuul简介" class="headerlink" title="一、Zuul简介"></a>一、Zuul简介</h2><p>Zuul的主要功能是路由转发和过滤器。路由功能是微服务的一部分，比如／api&#x2F;user转发到到user服务，&#x2F;api&#x2F;shop转发到到shop服务。zuul默认和Ribbon结合实现了负载均衡的功能。</p>
<p>zuul有以下功能：</p>
<ul>
<li>Authentication</li>
<li>Insights</li>
<li>Stress Testing</li>
<li>Canary Testing</li>
<li>Dynamic Routing</li>
<li>Service Migration</li>
<li>Load Shedding</li>
<li>Security</li>
<li>Static Response handling</li>
<li>Active&#x2F;Active traffic management</li>
</ul>
<h2 id="二、准备工作-3"><a href="#二、准备工作-3" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>继续使用上一节的工程。在原有的工程上，创建一个新的工程。</p>
<h2 id="三、创建service-zuul工程"><a href="#三、创建service-zuul工程" class="headerlink" title="三、创建service-zuul工程"></a>三、创建service-zuul工程</h2><p>其pom.xml文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;service-zuul&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;service-zuul&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;sc-f-chapter5&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在其入口applicaton类加上注解@EnableZuulProxy，开启zuul的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableZuulProxy</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ServiceZuulApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceZuulApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加上配置文件application.yml加上以下的配置代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br><span class="line">server:</span><br><span class="line">  port: 8769</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-zuul</span><br><span class="line">zuul:</span><br><span class="line">  routes:</span><br><span class="line">    api-a:</span><br><span class="line">      path: /api-a/**</span><br><span class="line">      serviceId: service-ribbon</span><br><span class="line">    api-b:</span><br><span class="line">      path: /api-b/**</span><br><span class="line">      serviceId: service-feign</span><br></pre></td></tr></table></figure>

<p>首先指定服务注册中心的地址为<a target="_blank" rel="noopener" href="http://localhost:8761/eureka/%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%AB%AF%E5%8F%A3%E4%B8%BA8769%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%90%8D%E4%B8%BAservice-zuul%EF%BC%9B%E4%BB%A5/api-a/">http://localhost:8761/eureka/，服务的端口为8769，服务名为service-zuul；以/api-a/</a> 开头的请求都转发给service-ribbon服务；以&#x2F;api-b&#x2F;开头的请求都转发给service-feign服务；</p>
<p>依次运行这五个工程;打开浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8769/api-a/hi?name=forezp">http://localhost:8769/api-a/hi?name=forezp</a> ;浏览器显示：</p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>打开浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8769/api-b/hi?name=forezp">http://localhost:8769/api-b/hi?name=forezp</a> ;浏览器显示：</p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>这说明zuul起到了路由的作用</p>
<h2 id="四、服务过滤"><a href="#四、服务过滤" class="headerlink" title="四、服务过滤"></a>四、服务过滤</h2><p>zuul不仅只是路由，并且还能过滤，做一些安全验证。继续改造工程；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyFilter extends ZuulFilter &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger log = LoggerFactory.getLogger(MyFilter.class);</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return &quot;pre&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        log.info(String.format(&quot;%s &gt;&gt;&gt; %s&quot;, request.getMethod(), request.getRequestURL().toString()));</span><br><span class="line">        Object accessToken = request.getParameter(&quot;token&quot;);</span><br><span class="line">        if(accessToken == null) &#123;</span><br><span class="line">            log.warn(&quot;token is empty&quot;);</span><br><span class="line">            ctx.setSendZuulResponse(false);</span><br><span class="line">            ctx.setResponseStatusCode(401);</span><br><span class="line">            try &#123;</span><br><span class="line">                ctx.getResponse().getWriter().write(&quot;token is empty&quot;);</span><br><span class="line">            &#125;catch (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;ok&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>filterType：返回一个字符串代表过滤器的类型，在zuul中定义了四种不同生命周期的过滤器类型，具体如下：<ul>
<li>pre：路由之前</li>
<li>routing：路由之时</li>
<li>post： 路由之后</li>
<li>error：发送错误调用</li>
</ul>
</li>
<li>filterOrder：过滤的顺序</li>
<li>shouldFilter：这里可以写逻辑判断，是否要过滤，本文true,永远过滤。</li>
<li>run：过滤器的具体逻辑。可用很复杂，包括查sql，nosql去判断该请求到底有没有权限访问。</li>
</ul>
<p>这时访问：<a target="_blank" rel="noopener" href="http://localhost:8769/api-a/hi?name=forezp">http://localhost:8769/api-a/hi?name=forezp</a> ；网页显示：</p>
<blockquote>
<p>token is empty</p>
</blockquote>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost:8769/api-a/hi?name=forezp&amp;token=22">http://localhost:8769/api-a/hi?name=forezp&amp;token=22</a> ； 网页显示：</p>
<blockquote>
<p>hi forezp,i am from port:8762</p>
</blockquote>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter5">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter5</a></p>
<h2 id="五、参考资料："><a href="#五、参考资料：" class="headerlink" title="五、参考资料："></a>五、参考资料：</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69939114">http://blog.csdn.net/forezp/article/details/69939114</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/05/sc-f5-zuul.html">https://www.fangzhipeng.com/springcloud/2018/08/05/sc-f5-zuul.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-2"><a href="#Post-Directory-2" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、Zuul简介</li>
<li>二、准备工作</li>
<li>三、创建service-zuul工程</li>
<li>四、服务过滤</li>
<li>五、参考资料：</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第6篇：config（F版本）"><a href="#SpringCloud教程第6篇：config（F版本）" class="headerlink" title="SpringCloud教程第6篇：config（F版本）"></a>SpringCloud教程第6篇：config（F版本）</h1><p> 2018&#x2F;08&#x2F;06</p>
<p>在上一篇文章讲述zuul的时候，已经提到过，使用配置服务来保存各个服务的配置文件。它就是Spring Cloud Config。</p>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件spring cloud config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中。在spring cloud config 组件中，分两个角色，一是config server，二是config client。</p>
<h2 id="二、构建Config-Server"><a href="#二、构建Config-Server" class="headerlink" title="二、构建Config Server"></a>二、构建Config Server</h2><p>父maven工程省略，父pom文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sc-f-chapter6&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;config-server&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;config-client&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;sc-f-chapter6&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.3.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>创建一个spring-boot项目，取名为config-server,其pom.xml如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;config-server&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;config-server&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;sc-f-chapter6&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在程序的入口Application类加上@EnableConfigServer注解开启配置服务器的功能，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableConfigServer</span><br><span class="line">public class ConfigServerApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ConfigServerApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要在程序的配置文件application.properties文件配置以下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-server</span><br><span class="line">server.port=8888</span><br><span class="line"></span><br><span class="line">spring.cloud.config.server.git.uri=https://github.com/forezp/SpringcloudConfig/</span><br><span class="line">spring.cloud.config.server.git.searchPaths=respo</span><br><span class="line">spring.cloud.config.label=master</span><br><span class="line">spring.cloud.config.server.git.username=</span><br><span class="line">spring.cloud.config.server.git.password=</span><br></pre></td></tr></table></figure>

<ul>
<li>spring.cloud.config.server.git.uri：配置git仓库地址</li>
<li>spring.cloud.config.server.git.searchPaths：配置仓库路径</li>
<li>spring.cloud.config.label：配置仓库的分支</li>
<li>spring.cloud.config.server.git.username：访问git仓库的用户名</li>
<li>spring.cloud.config.server.git.password：访问git仓库的用户密码</li>
</ul>
<p>如果Git仓库为公开仓库，可以不填写用户名和密码，如果是私有仓库需要填写，本例子是公开仓库，放心使用。</p>
<p>远程仓库<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringcloudConfig/">https://github.com/forezp/SpringcloudConfig/</a> 中有个文件config-client-dev.properties文件中有一个属性：</p>
<blockquote>
<p>foo &#x3D; foo version 3</p>
</blockquote>
<p>启动程序：访问<a target="_blank" rel="noopener" href="http://localhost:8888/foo/dev">http://localhost:8888/foo/dev</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;name&quot;:&quot;foo&quot;,&quot;profiles&quot;:[&quot;dev&quot;],&quot;label&quot;:&quot;master&quot;,</span><br><span class="line">&quot;version&quot;:&quot;792ffc77c03f4b138d28e89b576900ac5e01a44b&quot;,&quot;state&quot;:null,&quot;propertySources&quot;:[]&#125;</span><br></pre></td></tr></table></figure>

<p>证明配置服务中心可以从远程程序获取配置信息。</p>
<p>http请求地址和资源文件映射如下:</p>
<ul>
<li>&#x2F;{application}&#x2F;{profile}[&#x2F;{label}]</li>
<li>&#x2F;{application}-{profile}.yml</li>
<li>&#x2F;{label}&#x2F;{application}-{profile}.yml</li>
<li>&#x2F;{application}-{profile}.properties</li>
<li>&#x2F;{label}&#x2F;{application}-{profile}.properties</li>
</ul>
<h2 id="三、构建一个config-client"><a href="#三、构建一个config-client" class="headerlink" title="三、构建一个config client"></a>三、构建一个config client</h2><p>重新创建一个springboot项目，取名为config-client,其pom文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;config-client&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;config-client&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;sc-f-chapter6&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>其配置文件<strong>bootstrap.properties</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-client</span><br><span class="line">spring.cloud.config.label=master</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">spring.cloud.config.uri= http://localhost:8888/</span><br><span class="line">server.port=8881</span><br></pre></td></tr></table></figure>

<ul>
<li>spring.cloud.config.label 指明远程仓库的分支</li>
<li>spring.cloud.config.profile<ul>
<li>dev开发环境配置文件</li>
<li>test测试环境</li>
<li>pro正式环境</li>
</ul>
</li>
<li>spring.cloud.config.uri&#x3D; <a target="_blank" rel="noopener" href="http://localhost:8888/">http://localhost:8888/</a> 指明配置服务中心的网址。</li>
</ul>
<p>程序的入口类，写一个API接口“／hi”，返回从配置中心读取的foo变量的值，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@RestController</span><br><span class="line">public class ConfigClientApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ConfigClientApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Value(&quot;$&#123;foo&#125;&quot;)</span><br><span class="line">	String foo;</span><br><span class="line">	@RequestMapping(value = &quot;/hi&quot;)</span><br><span class="line">	public String hi()&#123;</span><br><span class="line">		return foo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开网址访问：<a target="_blank" rel="noopener" href="http://localhost:8881/hi%EF%BC%8C%E7%BD%91%E9%A1%B5%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8881/hi，网页显示：</a></p>
<blockquote>
<p>foo version 3</p>
</blockquote>
<p>这就说明，config-client从config-server获取了foo的属性，而config-server是从git仓库读取的,如图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-40ecbed6d38573d9.png" alt="Azure (2).png"></p>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter6">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter6</a></p>
<h2 id="四、参考资料-1"><a href="#四、参考资料-1" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70037291">http://blog.csdn.net/forezp/article/details/70037291</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/06/sc-f6-config.html">https://www.fangzhipeng.com/springcloud/2018/08/06/sc-f6-config.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-3"><a href="#Post-Directory-3" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、简介</li>
<li>二、构建Config Server</li>
<li>三、构建一个config client</li>
<li>四、参考资料</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第7篇：高可用的分布式配置中心（F版本）"><a href="#SpringCloud教程第7篇：高可用的分布式配置中心（F版本）" class="headerlink" title="SpringCloud教程第7篇：高可用的分布式配置中心（F版本）"></a>SpringCloud教程第7篇：高可用的分布式配置中心（F版本）</h1><p> 2018&#x2F;08&#x2F;07</p>
<p>上一篇文章讲述了一个服务如何从配置中心读取文件，配置中心如何从远程git读取配置文件，当服务实例很多时，都从配置中心读取文件，这时可以考虑将配置中心做成一个微服务，将其集群化，从而达到高可用，架构图如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-babe706075d72c58.png" alt="Azure (3).png"></p>
<h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><p>继续使用上一篇文章的工程，创建一个eureka-server工程，用作服务注册中心。</p>
<p>在其pom.xml文件引入Eureka的起步依赖spring-cloud-starter-netflix- eureka-server，代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;config-server&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;config-server&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;sc-f-chapter7&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在配置文件application.yml上，指定服务端口为8889，加上作为服务注册中心的基本配置，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8889</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">  client:</span><br><span class="line">    registerWithEureka: false</span><br><span class="line">    fetchRegistry: false</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br></pre></td></tr></table></figure>

<p>入口类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaServer</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class EurekaServerApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、改造config-server"><a href="#二、改造config-server" class="headerlink" title="二、改造config-server"></a>二、改造config-server</h2><p>在其pom.xml文件加上EurekaClient的起步依赖spring-cloud-starter-netflix-eureka-client，代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">	&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>配置文件application.yml，指定服务注册地址为<a target="_blank" rel="noopener" href="http://localhost:8889/eureka/%EF%BC%8C%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E5%90%8C%E4%B8%8A%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%8C%E5%AE%8C%E6%95%B4%E7%9A%84%E9%85%8D%E7%BD%AE%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:8889/eureka/，其他配置同上一篇文章，完整的配置如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-server</span><br><span class="line">server.port=8888</span><br><span class="line"></span><br><span class="line">spring.cloud.config.server.git.uri=https://github.com/forezp/SpringcloudConfig/</span><br><span class="line">spring.cloud.config.server.git.searchPaths=respo</span><br><span class="line">spring.cloud.config.label=master</span><br><span class="line">spring.cloud.config.server.git.username= your username</span><br><span class="line">spring.cloud.config.server.git.password= your password</span><br><span class="line">eureka.client.serviceUrl.defaultZone=http://localhost:8889/eureka/</span><br></pre></td></tr></table></figure>

<p>最后需要在程序的启动类Application加上@EnableEureka的注解。</p>
<h2 id="三、改造config-client"><a href="#三、改造config-client" class="headerlink" title="三、改造config-client"></a>三、改造config-client</h2><p>将其注册微到服务注册中心，作为Eureka客户端，需要pom文件加上起步依赖spring-cloud-starter-netflix-eureka-client，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>配置文件bootstrap.properties，注意是bootstrap。加上服务注册地址为<a target="_blank" rel="noopener" href="http://localhost:8889/eureka/">http://localhost:8889/eureka/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-client</span><br><span class="line">spring.cloud.config.label=master</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">#spring.cloud.config.uri= http://localhost:8888/</span><br><span class="line"></span><br><span class="line">eureka.client.serviceUrl.defaultZone=http://localhost:8889/eureka/</span><br><span class="line">spring.cloud.config.discovery.enabled=true</span><br><span class="line">spring.cloud.config.discovery.serviceId=config-server</span><br><span class="line">server.port=8881</span><br></pre></td></tr></table></figure>

<ul>
<li>spring.cloud.config.discovery.enabled 是从配置中心读取文件。</li>
<li>spring.cloud.config.discovery.serviceId 配置中心的servieId，即服务名。</li>
</ul>
<p>这时发现，在读取配置文件不再写ip地址，而是服务名，这时如果配置服务部署多份，通过负载均衡，从而高可用。</p>
<p>依次启动eureka-servr,config-server,config-client 访问网址：<a target="_blank" rel="noopener" href="http://localhost:8889/">http://localhost:8889/</a></p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-1639fdb713faa405.png" alt="Paste_Image.png"></p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8881/hi%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8881/hi，浏览器显示：</a></p>
<blockquote>
<p>foo version 3</p>
</blockquote>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter7">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter7</a></p>
<h2 id="四、参考资料-2"><a href="#四、参考资料-2" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><p><a target="_blank" rel="noopener" href="http://projects.spring.io/spring-cloud/spring-cloud.html#_spring_cloud_config">spring_cloud_config</a></p>
<h2 id="优秀文章推荐："><a href="#优秀文章推荐：" class="headerlink" title="优秀文章推荐："></a>优秀文章推荐：</h2><ul>
<li><table>
<thead>
<tr>
<th>[史上最简单的 SpringCloud 教程</th>
<th>终章](<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70148833">http://blog.csdn.net/forezp/article/details/70148833</a>)</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><table>
<thead>
<tr>
<th>[史上最简单的 SpringCloud 教程</th>
<th>第一篇: 服务的注册与发现（Eureka）](<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69696915">http://blog.csdn.net/forezp/article/details/69696915</a>)</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><table>
<thead>
<tr>
<th>[史上最简单的SpringCloud教程</th>
<th>第七篇: 高可用的分布式配置中心(Spring Cloud Config)](<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70037513">http://blog.csdn.net/forezp/article/details/70037513</a>)</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/07/sc-f7-config.html">https://www.fangzhipeng.com/springcloud/2018/08/07/sc-f7-config.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<h1 id="SpringCloud教程第8篇：Spring-Cloud-Bus（F版本）"><a href="#SpringCloud教程第8篇：Spring-Cloud-Bus（F版本）" class="headerlink" title="SpringCloud教程第8篇：Spring Cloud Bus（F版本）"></a>SpringCloud教程第8篇：Spring Cloud Bus（F版本）</h1><p> 2018&#x2F;08&#x2F;08</p>
<p>Spring Cloud Bus 将分布式的节点用轻量的消息代理连接起来。它可以用于广播配置文件的更改或者服务之间的通讯，也可以用于监控。本文要讲述的是用Spring Cloud Bus实现通知微服务架构的配置文件的更改。</p>
<h2 id="一、准备工作-1"><a href="#一、准备工作-1" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><p>本文还是基于上一篇文章来实现。按照官方文档，我们只需要在配置文件中配置 spring-cloud-starter-bus-amqp ；这就是说我们需要装rabbitMq，点击<a target="_blank" rel="noopener" href="http://www.rabbitmq.com/">rabbitmq</a>下载。至于怎么使用 rabbitmq，搜索引擎下。</p>
<h2 id="二、改造config-client"><a href="#二、改造config-client" class="headerlink" title="二、改造config-client"></a>二、改造config-client</h2><p>在pom文件加上起步依赖spring-cloud-starter-bus-amqp，完整的配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在配置文件application.properties中加上RabbitMq的配置，包括RabbitMq的地址、端口，用户名、密码。并需要加上spring.cloud.bus的三个配置，具体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=guest</span><br><span class="line">spring.rabbitmq.password=guest</span><br><span class="line"></span><br><span class="line">spring.cloud.bus.enabled=true</span><br><span class="line">spring.cloud.bus.trace.enabled=true</span><br><span class="line">management.endpoints.web.exposure.include=bus-refresh</span><br></pre></td></tr></table></figure>

<p>ConfigClientApplication启动类代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@RestController</span><br><span class="line">@RefreshScope</span><br><span class="line">public class ConfigClientApplication &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * http://localhost:8881/actuator/bus-refresh</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ConfigClientApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Value(&quot;$&#123;foo&#125;&quot;)</span><br><span class="line">	String foo;</span><br><span class="line"></span><br><span class="line">	@RequestMapping(value = &quot;/hi&quot;)</span><br><span class="line">	public String hi()&#123;</span><br><span class="line">		return foo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依次启动eureka-server、confg-cserver,启动两个config-client，端口为：8881、8882。</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8881/hi">http://localhost:8881/hi</a> 或者<a target="_blank" rel="noopener" href="http://localhost:8882/hi">http://localhost:8882/hi</a> 浏览器显示：</p>
<blockquote>
<p>foo version 3</p>
</blockquote>
<p>这时我们去<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringcloudConfig/blob/master/respo/config-client-dev.properties">代码仓库</a>将foo的值改为“foo version 4”，即改变配置文件foo的值。如果是传统的做法，需要重启服务，才能达到配置文件的更新。此时，我们只需要发送post请求：<a target="_blank" rel="noopener" href="http://localhost:8881/actuator/bus-refresh%EF%BC%8C%E4%BD%A0%E4%BC%9A%E5%8F%91%E7%8E%B0config-client%E4%BC%9A%E9%87%8D%E6%96%B0%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">http://localhost:8881/actuator/bus-refresh，你会发现config-client会重新读取配置文件</a></p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-c1fe748f1d25af70.png" alt="Paste_Image.png"></p>
<p>重新读取配置文件：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-57874b46c40c9916.png" alt="Paste_Image.png"></p>
<p>这时我们再访问<a target="_blank" rel="noopener" href="http://localhost:8881/hi">http://localhost:8881/hi</a> 或者<a target="_blank" rel="noopener" href="http://localhost:8882/hi">http://localhost:8882/hi</a> 浏览器显示：</p>
<blockquote>
<p>foo version 4</p>
</blockquote>
<p>另外，&#x2F;actuator&#x2F;bus-refresh接口可以指定服务，即使用”destination”参数，比如 “&#x2F;actuator&#x2F;bus-refresh?destination&#x3D;customers:**” 即刷新服务名为customers的所有服务。</p>
<h2 id="三、分析"><a href="#三、分析" class="headerlink" title="三、分析"></a>三、分析</h2><p>此时的架构图：<img src="https://www.fangzhipeng.com/img/jianshu/2279594-9a119d83cf90069f.png" alt="Paste_Image.png"></p>
<p>当git文件更改的时候，通过pc端用post 向端口为8882的config-client发送请求&#x2F;bus&#x2F;refresh／；此时8882端口会发送一个消息，由消息总线向其他服务传递，从而使整个微服务集群都达到更新配置文件。</p>
<h3 id="本文源码下载："><a href="#本文源码下载：" class="headerlink" title="本文源码下载："></a>本文源码下载：</h3><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter8">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter8</a></p>
<h2 id="五、参考资料-2"><a href="#五、参考资料-2" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70148235">http://blog.csdn.net/forezp/article/details/70148235</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/08/sc-f8-bus.html">https://www.fangzhipeng.com/springcloud/2018/08/08/sc-f8-bus.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-4"><a href="#Post-Directory-4" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li><p>一、准备工作</p>
</li>
<li><p>二、改造config-client</p>
</li>
<li><p>三、分析</p>
<ul>
<li>本文源码下载：</li>
</ul>
</li>
<li><p>五、参考资料</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第9篇：Sleuth（F版本）"><a href="#SpringCloud教程第9篇：Sleuth（F版本）" class="headerlink" title="SpringCloud教程第9篇：Sleuth（F版本）"></a>SpringCloud教程第9篇：Sleuth（F版本）</h1><p> 2018&#x2F;08&#x2F;09</p>
<p>这篇文章主要讲述服务追踪组件zipkin，Spring Cloud Sleuth集成了zipkin组件。</p>
<h2 id="一、简介-1"><a href="#一、简介-1" class="headerlink" title="一、简介"></a>一、简介</h2><blockquote>
<p>Add sleuth to the classpath of a Spring Boot application (see below for Maven and Gradle examples), and you will see the correlation data being collected in logs, as long as you are logging requests.</p>
<p>—— <a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-sleuth">摘自官网</a></p>
</blockquote>
<p>Spring Cloud Sleuth 主要功能就是在分布式系统中提供追踪解决方案，并且兼容支持了 zipkin，你只需要在pom文件中引入相应的依赖即可。</p>
<h2 id="二、服务追踪分析"><a href="#二、服务追踪分析" class="headerlink" title="二、服务追踪分析"></a>二、服务追踪分析</h2><p>微服务架构上通过业务来划分服务的，通过REST调用，对外暴露的一个接口，可能需要很多个服务协同才能完成这个接口功能，如果链路上任何一个服务出现问题或者网络超时，都会形成导致接口调用失败。随着业务的不断扩张，服务之间互相调用会越来越复杂。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-dd72907e82f89fd6.png" alt="Paste_Image.png"></p>
<p>随着服务的越来越多，对调用链的分析会越来越复杂。它们之间的调用关系也许如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-4b7d1b6abe595390.png" alt="Paste_Image.png"></p>
<h2 id="三、术语"><a href="#三、术语" class="headerlink" title="三、术语"></a>三、术语</h2><ul>
<li>Span：基本工作单元，例如，在一个新建的span中发送一个RPC等同于发送一个回应请求给RPC，span通过一个64位ID唯一标识，trace以另一个64位ID表示，span还有其他数据信息，比如摘要、时间戳事件、关键值注释(tags)、span的ID、以及进度ID(通常是IP地址) span在不断的启动和停止，同时记录了时间信息，当你创建了一个span，你必须在未来的某个时刻停止它。</li>
<li>Trace：一系列spans组成的一个树状结构，例如，如果你正在跑一个分布式大数据工程，你可能需要创建一个trace。</li>
<li>Annotation：用来及时记录一个事件的存在，一些核心annotations用来定义一个请求的开始和结束<ul>
<li>cs - Client Sent -客户端发起一个请求，这个annotion描述了这个span的开始</li>
<li>sr - Server Received -服务端获得请求并准备开始处理它，如果将其sr减去cs时间戳便可得到网络延迟</li>
<li>ss - Server Sent -注解表明请求处理的完成(当请求返回客户端)，如果ss减去sr时间戳便可得到服务端需要的处理请求时间</li>
<li>cr - Client Received -表明span的结束，客户端成功接收到服务端的回复，如果cr减去cs时间戳便可得到客户端从服务端获取回复的所有所需时间 将Span和Trace在一个系统中使用Zipkin注解的过程图形化：</li>
</ul>
</li>
</ul>
<p>将Span和Trace在一个系统中使用Zipkin注解的过程图形化：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-4b865f2a2c271def.png" alt="Paste_Image.png"></p>
<h2 id="四、构建工程"><a href="#四、构建工程" class="headerlink" title="四、构建工程"></a>四、构建工程</h2><p>基本知识讲解完毕，下面我们来实战，本文的案例主要有三个工程组成:一个server-zipkin,它的主要作用使用ZipkinServer 的功能，收集调用数据，并展示；一个service-hi,对外暴露hi接口；一个service-miya,对外暴露miya接口；这两个service可以相互调用；并且只有调用了，server-zipkin才会收集数据的，这就是为什么叫服务追踪了。</p>
<h3 id="4-1-构建server-zipkin"><a href="#4-1-构建server-zipkin" class="headerlink" title="4.1 构建server-zipkin"></a>4.1 构建server-zipkin</h3><p>在spring Cloud为F版本的时候，已经不需要自己构建Zipkin Server了，只需要下载jar即可，下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/</a></p>
<p>也可以在这里<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter9">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter9</a> 下载。下载完成jar 包之后，需要运行jar，如下：</p>
<blockquote>
<p>java -jar zipkin-server-2.10.1-exec.jar</p>
</blockquote>
<p>访问浏览器localhost:9494</p>
<h3 id="4-2-创建service-hi"><a href="#4-2-创建service-hi" class="headerlink" title="4.2 创建service-hi"></a>4.2 创建service-hi</h3><p>在其pom引入起步依赖spring-cloud-starter-zipkin，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">		 xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;service-zipkin&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;service-hi&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;com.forezp&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;sc-f-chapter9&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>在其配置文件application.yml指定zipkin server的地址，头通过配置“spring.zipkin.base-url”指定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.port=8988</span><br><span class="line">spring.zipkin.base-url=http://localhost:9411</span><br><span class="line">spring.application.name=service-hi</span><br></pre></td></tr></table></figure>

<p>通过引入spring-cloud-starter-zipkin依赖和设置spring.zipkin.base-url就可以了。</p>
<p>对外暴露接口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package com.forezp;</span><br><span class="line"></span><br><span class="line">import brave.sampler.Sampler;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line">import java.util.logging.Level;</span><br><span class="line">import java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@RestController</span><br><span class="line">public class ServiceHiApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ServiceHiApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static final Logger LOG = Logger.getLogger(ServiceHiApplication.class.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public RestTemplate getRestTemplate()&#123;</span><br><span class="line">		return new RestTemplate();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@RequestMapping(&quot;/hi&quot;)</span><br><span class="line">	public String callHome()&#123;</span><br><span class="line">		LOG.log(Level.INFO, &quot;calling trace service-hi  &quot;);</span><br><span class="line">		return restTemplate.getForObject(&quot;http://localhost:8989/miya&quot;, String.class);</span><br><span class="line">	&#125;</span><br><span class="line">	@RequestMapping(&quot;/info&quot;)</span><br><span class="line">	public String info()&#123;</span><br><span class="line">		LOG.log(Level.INFO, &quot;calling trace service-hi &quot;);</span><br><span class="line"></span><br><span class="line">		return &quot;i&#x27;m service-hi&quot;;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public Sampler defaultSampler() &#123;</span><br><span class="line">		return Sampler.ALWAYS_SAMPLE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-创建service-miya"><a href="#4-3-创建service-miya" class="headerlink" title="4.3 创建service-miya"></a>4.3 创建service-miya</h3><p>创建过程痛service-hi，引入相同的依赖，配置下spring.zipkin.base-url。</p>
<p>对外暴露接口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.forezp;</span><br><span class="line"></span><br><span class="line">import brave.sampler.Sampler;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">import java.util.logging.Level;</span><br><span class="line">import java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@RestController</span><br><span class="line">public class ServiceMiyaApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ServiceMiyaApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static final Logger LOG = Logger.getLogger(ServiceMiyaApplication.class.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@RequestMapping(&quot;/hi&quot;)</span><br><span class="line">	public String home()&#123;</span><br><span class="line">		LOG.log(Level.INFO, &quot;hi is being called&quot;);</span><br><span class="line">		return &quot;hi i&#x27;m miya!&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@RequestMapping(&quot;/miya&quot;)</span><br><span class="line">	public String info()&#123;</span><br><span class="line">		LOG.log(Level.INFO, &quot;info is being called&quot;);</span><br><span class="line">		return restTemplate.getForObject(&quot;http://localhost:8988/info&quot;,String.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public RestTemplate getRestTemplate()&#123;</span><br><span class="line">		return new RestTemplate();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public Sampler defaultSampler() &#123;</span><br><span class="line">		return Sampler.ALWAYS_SAMPLE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-启动工程，演示追踪"><a href="#4-4-启动工程，演示追踪" class="headerlink" title="4.4 启动工程，演示追踪"></a>4.4 启动工程，演示追踪</h3><p>依次启动上面的工程，打开浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:9411/%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E4%BB%A5%E4%B8%8B%E7%95%8C%E9%9D%A2%EF%BC%9A">http://localhost:9411/，会出现以下界面：</a></p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-d5461a49188ec624.png" alt="Paste_Image.png"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8989/miya%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E5%87%BA%E7%8E%B0%EF%BC%9A">http://localhost:8989/miya，浏览器出现：</a></p>
<blockquote>
<p>i’m service-hi</p>
</blockquote>
<p>再打开<a target="_blank" rel="noopener" href="http://localhost:9411/%E7%9A%84%E7%95%8C%E9%9D%A2%EF%BC%8C%E7%82%B9%E5%87%BBDependencies,%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%EF%BC%9A">http://localhost:9411/的界面，点击Dependencies,可以发现服务的依赖关系：</a></p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-48cfbe426b23b7a5.png" alt="Paste_Image.png"></p>
<p>点击find traces,可以看到具体服务相互调用的数据：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-3fe448b513ad867b.png" alt="Paste_Image.png"></p>
<p>本文源码下载：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter9">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter9</a></p>
<h2 id="五、参考资料-3"><a href="#五、参考资料-3" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-sleuth">spring-cloud-sleuth</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70162074">http://blog.csdn.net/forezp/article/details/70162074</a></p>
<p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html">http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/09/sc-f9-sleuth.html">https://www.fangzhipeng.com/springcloud/2018/08/09/sc-f9-sleuth.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-5"><a href="#Post-Directory-5" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li><p>一、简介</p>
</li>
<li><p>二、服务追踪分析</p>
</li>
<li><p>三、术语</p>
</li>
<li><p>四、构建工程</p>
<ul>
<li><p>4.1 构建server-zipkin</p>
</li>
<li><p>4.2 创建service-hi</p>
</li>
<li><p>4.3 创建service-miya</p>
</li>
<li><p>4.4 启动工程，演示追踪</p>
</li>
</ul>
</li>
<li><p>五、参考资料</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第10篇：高可用的服务注册中心（F版本）"><a href="#SpringCloud教程第10篇：高可用的服务注册中心（F版本）" class="headerlink" title="SpringCloud教程第10篇：高可用的服务注册中心（F版本）"></a>SpringCloud教程第10篇：高可用的服务注册中心（F版本）</h1><p> 2018&#x2F;08&#x2F;10</p>
<h2 id="一、准备工作-2"><a href="#一、准备工作-2" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><blockquote>
<p>Eureka can be made even more resilient and available by running multiple instances and asking them to register with each other. In fact, this is the default behaviour, so all you need to do to make it work is add a valid serviceUrl to a peer, e.g.</p>
<p>摘自官网</p>
</blockquote>
<p>Eureka通过运行多个实例，使其更具有高可用性。事实上，这是它默认的熟性，你需要做的就是给对等的实例一个合法的关联serviceurl。</p>
<p>这篇文章我们基于<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter1">第一篇文章的工程</a>，来做修改。</p>
<h2 id="二、改造工作"><a href="#二、改造工作" class="headerlink" title="二、改造工作"></a>二、改造工作</h2><p>在eureka-server工程中resources文件夹下，创建配置文件application-peer1.yml:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  profiles: peer1</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: peer1</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://peer2:8769/eureka/</span><br></pre></td></tr></table></figure>

<p>并且创建另外一个配置文件application-peer2.yml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8769</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  profiles: peer2</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: peer2</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://peer1:8761/eureka/</span><br></pre></td></tr></table></figure>

<p>这时eureka-server就已经改造完毕。</p>
<blockquote>
<p>ou could use this configuration to test the peer awareness on a single host (there’s not much value in doing that in production) by manipulating &#x2F;etc&#x2F;hosts to resolve the host names.</p>
</blockquote>
<p>按照官方文档的指示，需要改变etc&#x2F;hosts，linux系统通过vim &#x2F;etc&#x2F;hosts ,加上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 peer1</span><br><span class="line">127.0.0.1 peer2</span><br></pre></td></tr></table></figure>

<p>windows电脑，在c:&#x2F;windows&#x2F;systems&#x2F;drivers&#x2F;etc&#x2F;hosts 修改。</p>
<p>这时需要改造下service-hi:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://peer1:8761/eureka/</span><br><span class="line">server:</span><br><span class="line">  port: 8762</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-hi</span><br></pre></td></tr></table></figure>

<h2 id="三、启动工程"><a href="#三、启动工程" class="headerlink" title="三、启动工程"></a>三、启动工程</h2><p>启动eureka-server：</p>
<blockquote>
<p>java -jar eureka-server-0.0.1-SNAPSHOT.jar - -spring.profiles.active&#x3D;peer1</p>
<p>java -jar eureka-server-0.0.1-SNAPSHOT.jar - -spring.profiles.active&#x3D;peer2</p>
</blockquote>
<blockquote>
</blockquote>
<p>启动service-hi:</p>
<blockquote>
<p>java -jar service-hi-0.0.1-SNAPSHOT.jar</p>
</blockquote>
<p>访问：localhost:8761,如图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-659c68e405bd70bd.png" alt="Paste_Image.png"></p>
<p>你会发现注册了service-hi，并且有个peer2节点，同理访问localhost:8769你会发现有个peer1节点。</p>
<p>client只向8761注册，但是你打开8769，你也会发现，8769也有 client的注册信息。</p>
<p>个人感受：这是通过看官方文档的写的demo ，但是需要手动改host是不是不符合Spring Cloud 的高上大？</p>
<blockquote>
<h2 id="Prefer-IP-Address"><a href="#Prefer-IP-Address" class="headerlink" title="Prefer IP Address"></a>Prefer IP Address</h2><p>In some cases, it is preferable for Eureka to advertise the IP Adresses of services rather than the hostname. Set eureka.instance.preferIpAddress to true and when the application registers with eureka, it will use its IP Address rather than its hostname.</p>
<p>摘自官网</p>
</blockquote>
<p>eureka.instance.preferIpAddress&#x3D;true是通过设置ip让eureka让其他服务注册它。也许能通过去改变去通过改变host的方式。</p>
<p>此时的架构图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-a052854a3084fdd6.png" alt="有点丑e.png"></p>
<p>Eureka-eserver peer1 8761,Eureka-eserver peer2 8769相互感应，当有服务注册时，两个Eureka-eserver是对等的，它们都存有相同的信息，这就是通过服务器的冗余来增加可靠性，当有一台服务器宕机了，服务并不会终止，因为另一台服务存有相同的数据。</p>
<p>本文源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter10">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter10</a></p>
<h2 id="四、参考文献"><a href="#四、参考文献" class="headerlink" title="四、参考文献"></a>四、参考文献</h2><p><a target="_blank" rel="noopener" href="http://projects.spring.io/spring-cloud/spring-cloud.html#_high_availability_zones_and_regions">high_availability_zones</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/70183572">http://blog.csdn.net/forezp/article/details/70183572</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/10/sc-f10-eureka.html">https://www.fangzhipeng.com/springcloud/2018/08/10/sc-f10-eureka.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-6"><a href="#Post-Directory-6" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、准备工作</li>
<li>二、改造工作</li>
<li>三、启动工程</li>
<li>Prefer IP Address</li>
<li>四、参考文献</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="史上最简单的SpringCloud教程-第十一篇-docker部署spring-cloud项目"><a href="#史上最简单的SpringCloud教程-第十一篇-docker部署spring-cloud项目" class="headerlink" title="史上最简单的SpringCloud教程 | 第十一篇: docker部署spring cloud项目"></a>史上最简单的SpringCloud教程 | 第十一篇: docker部署spring cloud项目</h1><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/original.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="https://forezp.blog.csdn.net/">方志朋</a> 2017-04-16 22:02:22 <img src="https://csdnimg.cn/release/blogv2/dist/pc/img/articleReadEyes.png" alt="img"> 188562 <img src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollect.png" alt="img"> 收藏 41</p>
<p>分类专栏： <a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/category_6830968.html">springcloud</a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/category_9268575.html">史上最简单的 Spring Cloud 教程</a> 文章标签： <a target="_blank" rel="noopener" href="https://www.csdn.net/gather_22/MtTaEg0sMDg2NTAtYmxvZwO0O0OO0O0O.html">spring</a> <a target="_blank" rel="noopener" href="https://www.csdn.net/gather_27/NtzaUgysMTg1NC1ibG9n.html">数据库</a> <a target="_blank" rel="noopener" href="https://www.csdn.net/gather_2a/MtTaEg0sMDI1NTYtYmxvZwO0O0OO0O0O.html">web应用</a> <a target="_blank" rel="noopener" href="https://www.csdn.net/gather_26/MtTaYg1sNjc2OS1ibG9n.html">openstack</a> <a target="_blank" rel="noopener" href="https://www.csdn.net/gather_24/MtTaEg0sMDg3NDgtYmxvZwO0O0OO0O0O.html">自动化测试</a></p>
<p>版权</p>
<blockquote>
<p>转载请标明出处：<br>原文首发于：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2017/06/11/sc11-docker.html">https://www.fangzhipeng.com/springcloud/2017/06/11/sc11-docker.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><strong>个人博客纯净版：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2017/06/13/sc13-turbine.html">https://www.fangzhipeng.com/springcloud/2017/06/13/sc13-turbine.html</a></strong></p>
<h2 id="一、docker简介"><a href="#一、docker简介" class="headerlink" title="一、docker简介"></a>一、docker简介</h2><p>Docker是一个开源的引擎，可以轻松的为任何应用创建一个轻量级的、可移植的、自给自足的容器。开发者在笔记本上编译测试通过的容器可以批量地在生产环境中部署，包括VMs（虚拟机）、bare metal、OpenStack 集群和其他的基础应用平台。<br>Docker通常用于如下场景：</p>
<ul>
<li>web应用的自动化打包和发布；</li>
<li>自动化测试和持续集成、发布；</li>
<li>在服务型环境中部署和调整数据库或其他的后台应用；</li>
<li>从头编译或者扩展现有的OpenShift或Cloud Foundry平台来搭建自己的PaaS环境。</li>
</ul>
<p>Docker 的优点</p>
<ul>
<li>1、简化程序：<br>Docker 让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，便可以实现虚拟化。Docker改变了虚拟化的方式，使开发者可以直接将自己的成果放入Docker中进行管理。方便快捷已经是 Docker的最大优势，过去需要用数天乃至数周的 任务，在Docker容器的处理下，只需要数秒就能完成。</li>
<li>2、避免选择恐惧症：<br>如果你有选择恐惧症，还是资深患者。Docker 帮你 打包你的纠结！比如 Docker 镜像；Docker 镜像中包含了运行环境和配置，所以 Docker 可以简化部署多种应用实例工作。比如 Web 应用、后台应用、数据库应用、大数据应用比如 Hadoop 集群、消息队列等等都可以打包成一个镜像部署。</li>
<li>3、节省开支：<br>一方面，云计算时代到来，使开发者不必为了追求效果而配置高额的硬件，Docker 改变了高性能必然高价格的思维定势。Docker 与云的结合，让云空间得到更充分的利用。不仅解决了硬件管理的问题，也改变了虚拟化的方式。</li>
</ul>
<p>上面文字参考了相关文章；另，关于docker 的安装和基本的使用见<a target="_blank" rel="noopener" href="http://www.runoob.com/docker/docker-tutorial.html">相关教程</a>。</p>
<h2 id="二、准备工作-4"><a href="#二、准备工作-4" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>环境条件：</p>
<ul>
<li>linux系统，不建议windows</li>
<li>docker最新版本</li>
<li>jdk 1.8</li>
<li>maven3.0</li>
</ul>
<p>本文采用的工程来自第一篇文章的工程，采用maven的方式去构建项目，并采用docker-maven-plugin去构建docker镜像。</p>
<h2 id="三、改造工程、构建镜像"><a href="#三、改造工程、构建镜像" class="headerlink" title="三、改造工程、构建镜像"></a>三、改造工程、构建镜像</h2><h5 id="改造eureka-server工程"><a href="#改造eureka-server工程" class="headerlink" title="改造eureka-server工程"></a>改造eureka-server工程</h5><p>在pom文件加上插件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">			&lt;!-- tag::plugin[] --&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;com.spotify&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;0.4.3&lt;/version&gt;</span><br><span class="line">				&lt;configuration&gt;</span><br><span class="line">					&lt;imageName&gt;$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt;</span><br><span class="line">					&lt;dockerDirectory&gt;src/main/docker&lt;/dockerDirectory&gt;</span><br><span class="line">					&lt;resources&gt;</span><br><span class="line">						&lt;resource&gt;</span><br><span class="line">							&lt;targetPath&gt;/&lt;/targetPath&gt;</span><br><span class="line">							&lt;directory&gt;$&#123;project.build.directory&#125;&lt;/directory&gt;</span><br><span class="line">							&lt;include&gt;$&#123;project.build.finalName&#125;.jar&lt;/include&gt;</span><br><span class="line">						&lt;/resource&gt;</span><br><span class="line">					&lt;/resources&gt;</span><br><span class="line">				&lt;/configuration&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">			&lt;!-- end::plugin[] --&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line">123456789101112131415161718192021222324252627</span><br></pre></td></tr></table></figure>

<p>Spotify 的 docker-maven-plugin 插件是用maven插件方式构建docker镜像的。</p>
<ul>
<li>imageName指定了镜像的名字，本例为 forep&#x2F;eureka-server</li>
<li>dockerDirectory指定 Dockerfile 的位置</li>
<li>resources是指那些需要和 Dockerfile 放在一起，在构建镜像时使用的文件，一般应用 jar 包需要纳入。</li>
</ul>
<p>修改下配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">  client:</span><br><span class="line">    registerWithEureka: false</span><br><span class="line">    fetchRegistry: false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12345678910</span><br></pre></td></tr></table></figure>

<h4 id="编写dockerfile文件："><a href="#编写dockerfile文件：" class="headerlink" title="编写dockerfile文件："></a>编写dockerfile文件：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM frolvlad/alpine-oraclejdk8:slim</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ADD eureka-server-0.0.1-SNAPSHOT.jar app.jar</span><br><span class="line">#RUN bash -c &#x27;touch /app.jar&#x27;</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class="line">EXPOSE 8761</span><br><span class="line"></span><br><span class="line">1234567</span><br></pre></td></tr></table></figure>

<h4 id="docker-file编写指令："><a href="#docker-file编写指令：" class="headerlink" title="docker file编写指令："></a>docker file编写指令：</h4><ul>
<li>FROM</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	FROM &lt;image&gt;</span><br><span class="line">	FROM &lt;image&gt;:&lt;tag&gt;</span><br><span class="line">	FROM &lt;image&gt; &lt;digest&gt;</span><br><span class="line"></span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>FROM指令必须指定且需要在Dockerfile其他指令的前面，指定的基础image可以是官方远程仓库中的，也可以位于本地仓库。后续的指令都依赖于该指令指定的image。当在同一个Dockerfile中建立多个镜像时，可以使用多个FROM指令。</p>
<ul>
<li>VOLUME</li>
</ul>
<p>格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	 VOLUME [&quot;/data&quot;]</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>使容器中的一个目录具有持久化存储数据的功能，该目录可以被容器本身使用，也可以共享给其他容器。当容器中的应用有持久化数据的需求时可以在Dockerfile中使用该指令。</p>
<ul>
<li>ADD</li>
</ul>
<p>从src目录复制文件到容器的dest。其中src可以是Dockerfile所在目录的相对路径，也可以是一个URL，还可以是一个压缩包</p>
<ul>
<li>ENTRYPOINT</li>
</ul>
<p>指定Docker容器启动时执行的命令，可以多次设置，但是只有最后一个有效。</p>
<ul>
<li>EXPOSE</li>
</ul>
<p>为Docker容器设置对外的端口号。在启动时，可以使用-p选项或者-P选项。</p>
<h4 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h4><p>执行构建docker镜像maven命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn clean</span><br><span class="line">mvn package docker:build</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190601114057480.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9mb3JlenAuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>构建eureka-server镜像成功。</p>
<h4 id="同理构建service-hi镜像"><a href="#同理构建service-hi镜像" class="headerlink" title="同理构建service-hi镜像"></a>同理构建service-hi镜像</h4><ul>
<li>pom文件导入同eurek-server</li>
<li>修改下配置文件：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://eureka-server:8761/eureka/ # 这个需要改为eureka-server</span><br><span class="line">server:</span><br><span class="line">  port: 8763</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-hi</span><br><span class="line"></span><br><span class="line">12345678910</span><br></pre></td></tr></table></figure>

<p>在这里说下：defaultZone发现服务的host改为镜像名。</p>
<ul>
<li>dockefile 编写同eureka-server</li>
<li>构建镜像：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn clean</span><br><span class="line">mvn package docker:build</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190601114116418.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9mb3JlenAuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这时我们运行docke的eureka-server 和service-hi镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8761: 8761 -t forezp/eureka-server</span><br><span class="line">docker run -p 8763: 8763 -t forezp/service-hi</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>访问localhost:8761</p>
<p><img src="https://img-blog.csdnimg.cn/20190601114134655.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9mb3JlenAuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="四、采用docker-compose启动镜像"><a href="#四、采用docker-compose启动镜像" class="headerlink" title="四、采用docker-compose启动镜像"></a>四、采用docker-compose启动镜像</h2><p>Compose 是一个用于定义和运行多容器的Docker应用的工具。使用Compose，你可以在一个配置文件（yaml格式）中配置你应用的服务，然后使用一个命令，即可创建并启动配置中引用的所有服务。下面我们进入Compose的实战吧。</p>
<p>采用docker-compose的方式编排镜像，启动镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">  eureka-server:</span><br><span class="line">    image: forezp/eureka-server</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8761:8761</span><br><span class="line"></span><br><span class="line">  service-hi:</span><br><span class="line">    image: forezp/service-hi</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8763:8763</span><br><span class="line">12345678910111213</span><br></pre></td></tr></table></figure>

<p>输入命令： docker-compose up</p>
<p><img src="https://img-blog.csdnimg.cn/201906011142016.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9mb3JlenAuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>发现2个镜像按照指定的顺序启动了。</p>
<p>源码下载：<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/chapter11">https://github.com/forezp/SpringCloudLearning/tree/master/chapter11</a></p>
<h2 id="五、采用docker-compose编排并启动镜像"><a href="#五、采用docker-compose编排并启动镜像" class="headerlink" title="五、采用docker-compose编排并启动镜像"></a>五、采用docker-compose编排并启动镜像</h2><p>docker-compose也可以构建镜像，现在我们采用docker-compose的方式构建镜像。</p>
<p>现在以eureka-server为例：<br>将Dockerfile移到eureka-server的主目录，改写ADD的相对路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM frolvlad/alpine-oraclejdk8:slim</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ADD ./target/eureka-server-0.0.1-SNAPSHOT.jar app.jar</span><br><span class="line">#RUN bash -c &#x27;touch /app.jar&#x27;</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class="line">EXPOSE 8761</span><br><span class="line">1234567</span><br></pre></td></tr></table></figure>

<p>同理修改service-hi目录；</p>
<p>编写构建镜像docker-compose-dev文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">  eureka-server:</span><br><span class="line">    build: eureka-server</span><br><span class="line">    ports:</span><br><span class="line">      - 8761:8761</span><br><span class="line"></span><br><span class="line">  service-hi:</span><br><span class="line">    build: service-hi</span><br><span class="line">    ports:</span><br><span class="line">      - 8763:8763</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12345678910111213</span><br></pre></td></tr></table></figure>

<p>命令构建镜像并启动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose.yml -f docker-compose-dev.yml up </span><br><span class="line"></span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190601114221265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9mb3JlenAuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>源码下载：<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/chapter11-2">https://github.com/forezp/SpringCloudLearning/tree/master/chapter11-2</a></p>
<h3 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/70148833">史上最简单的 SpringCloud 教程汇总</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/70341818">SpringBoot教程汇总</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/85163411">Java面试题系列汇总</a></p>
<h2 id="六、参考文献"><a href="#六、参考文献" class="headerlink" title="六、参考文献"></a>六、参考文献</h2><p><a target="_blank" rel="noopener" href="http://www.runoob.com/docker/docker-tutorial.html">docker教程</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/47344">用 Docker 构建、运行、发布一个 Spring Boot 应用</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/docker/compose">docker-compose</a></p>
<p><img src="https://img-blog.csdn.net/20170708155617159?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZm9yZXpw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img"><br>扫码关注公众号有惊喜</p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a>）</strong></p>
<h1 id="SpringCloud教程第12篇：Hystrix-Dashboard（F版本）"><a href="#SpringCloud教程第12篇：Hystrix-Dashboard（F版本）" class="headerlink" title="SpringCloud教程第12篇：Hystrix Dashboard（F版本）"></a>SpringCloud教程第12篇：Hystrix Dashboard（F版本）</h1><p> 2018&#x2F;08&#x2F;12</p>
<p>在我的第四篇文章<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69934399">断路器</a>讲述了如何使用断路器，并简单的介绍了下Hystrix Dashboard组件，这篇文章更加详细的介绍Hystrix Dashboard。</p>
<h2 id="一、Hystrix-Dashboard简介"><a href="#一、Hystrix-Dashboard简介" class="headerlink" title="一、Hystrix Dashboard简介"></a>一、Hystrix Dashboard简介</h2><p>在微服务架构中为例保证程序的可用性，防止程序出错导致网络阻塞，出现了断路器模型。断路器的状况反应了一个程序的可用性和健壮性，它是一个重要指标。Hystrix Dashboard是作为断路器状态的一个组件，提供了数据监控和友好的图形化界面。</p>
<h2 id="二、准备工作-5"><a href="#二、准备工作-5" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>本文的的工程栗子，来源于<a target="_blank" rel="noopener" href="http://blog.csdn.net/forezp/article/details/69696915">第一篇文章</a>的栗子，在它的基础上进行改造。</p>
<h2 id="三、开始改造service-hi"><a href="#三、开始改造service-hi" class="headerlink" title="三、开始改造service-hi"></a>三、开始改造service-hi</h2><p>在pom的工程文件引入相应的依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>其中，这三个依赖是必须的，缺一不可。</p>
<p>在程序的入口ServiceHiApplication类，加上@EnableHystrix注解开启断路器，这个是必须的，并且需要在程序中声明断路点HystrixCommand；加上@EnableHystrixDashboard注解，开启HystrixDashboard</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@RestController</span><br><span class="line">@EnableHystrix</span><br><span class="line">@EnableHystrixDashboard</span><br><span class="line">@EnableCircuitBreaker</span><br><span class="line">public class ServiceHiApplication &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 访问地址 http://localhost:8762/actuator/hystrix.stream</span><br><span class="line">     * @param args</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceHiApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;server.port&#125;&quot;)</span><br><span class="line">    String port;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/hi&quot;)</span><br><span class="line">    @HystrixCommand(fallbackMethod = &quot;hiError&quot;)</span><br><span class="line">    public String home(@RequestParam(value = &quot;name&quot;, defaultValue = &quot;forezp&quot;) String name) &#123;</span><br><span class="line">        return &quot;hi &quot; + name + &quot; ,i am from port:&quot; + port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String hiError(String name) &#123;</span><br><span class="line">        return &quot;hi,&quot;+name+&quot;,sorry,error!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行程序： 依次开启eureka-server 和service-hi.</p>
<h2 id="四、Hystrix-Dashboard图形展示"><a href="#四、Hystrix-Dashboard图形展示" class="headerlink" title="四、Hystrix Dashboard图形展示"></a>四、Hystrix Dashboard图形展示</h2><p>打开<a target="_blank" rel="noopener" href="http://localhost:8762/actuator/hystrix.stream%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E4%BA%9B%E5%85%B7%E4%BD%93%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9A">http://localhost:8762/actuator/hystrix.stream，可以看到一些具体的数据：</a></p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc12-1.jpeg" alt="这里写图片描述"></p>
<p>打开locahost:8762&#x2F;hystrix 可以看见以下界面：</p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc12-2.jpeg" alt="这里写图片描述"></p>
<p>在界面依次输入：<a target="_blank" rel="noopener" href="http://localhost:8762/actuator/hystrix.stream">http://localhost:8762/actuator/hystrix.stream</a> 、2000 、miya ；点确定。</p>
<p>在另一个窗口输入： <a target="_blank" rel="noopener" href="http://localhost:8762/hi?name=forezp">http://localhost:8762/hi?name=forezp</a></p>
<p>重新刷新hystrix.stream网页，你会看到良好的图形化界面：</p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc12-3.jpeg" alt="这里写图片描述"></p>
<p>源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter12">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter12</a></p>
<h2 id="五、参考资料-4"><a href="#五、参考资料-4" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard">hystrix-dashboard</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/12/sc-f12-dash.html">https://www.fangzhipeng.com/springcloud/2018/08/12/sc-f12-dash.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-7"><a href="#Post-Directory-7" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、Hystrix Dashboard简介</li>
<li>二、准备工作</li>
<li>三、开始改造service-hi</li>
<li>四、Hystrix Dashboard图形展示</li>
<li>五、参考资料</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="SpringCloud教程第13篇：Turbine-F版本"><a href="#SpringCloud教程第13篇：Turbine-F版本" class="headerlink" title="SpringCloud教程第13篇：Turbine(F版本)"></a>SpringCloud教程第13篇：Turbine(F版本)</h1><p> 2018&#x2F;08&#x2F;13</p>
<p>上一篇文章讲述了如何利用Hystrix Dashboard去监控断路器的Hystrix command。当我们有很多个服务的时候，这就需要聚合所以服务的Hystrix Dashboard的数据了。这就需要用到Spring Cloud的另一个组件了，即Hystrix Turbine。</p>
<h2 id="一、Hystrix-Turbine简介"><a href="#一、Hystrix-Turbine简介" class="headerlink" title="一、Hystrix Turbine简介"></a>一、Hystrix Turbine简介</h2><p>看单个的Hystrix Dashboard的数据并没有什么多大的价值，要想看这个系统的Hystrix Dashboard数据就需要用到Hystrix Turbine。Hystrix Turbine将每个服务Hystrix Dashboard数据进行了整合。Hystrix Turbine的使用非常简单，只需要引入相应的依赖和加上注解和配置就可以了。</p>
<h2 id="二、准备工作-6"><a href="#二、准备工作-6" class="headerlink" title="二、准备工作"></a>二、准备工作</h2><p>本文使用的工程为上一篇文章的工程，在此基础上进行改造。因为我们需要多个服务的Dashboard，所以需要再建一个服务，取名为service-lucy，它的基本配置同service-hi，具体见<a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter13">源码</a>,在这里就不详细说明。</p>
<h2 id="三、创建service-turbine"><a href="#三、创建service-turbine" class="headerlink" title="三、创建service-turbine"></a>三、创建service-turbine</h2><p>引入相应的依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-turbine&lt;/artifactId&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">   &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>在其入口类ServiceTurbineApplication加上注解@EnableTurbine，开启turbine，@EnableTurbine注解包含了@EnableDiscoveryClient注解，即开启了注册服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@RestController</span><br><span class="line">@EnableHystrix</span><br><span class="line">@EnableHystrixDashboard</span><br><span class="line">@EnableCircuitBreaker</span><br><span class="line">@EnableTurbine</span><br><span class="line">public class ServiceTurbineApplication &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * http://localhost:8764/turbine.stream</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run( ServiceTurbineApplication.class, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件application.yml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8764</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-turbine</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &quot;*&quot;</span><br><span class="line">      cors:</span><br><span class="line">        allowed-origins: &quot;*&quot;</span><br><span class="line">        allowed-methods: &quot;*&quot;</span><br><span class="line"></span><br><span class="line">turbine:</span><br><span class="line">  app-config: service-hi,service-lucy</span><br><span class="line">  aggregator:</span><br><span class="line">    clusterConfig: default</span><br><span class="line">  clusterNameExpression: new String(&quot;default&quot;)</span><br><span class="line">  combine-host: true</span><br><span class="line">  instanceUrlSuffix:</span><br><span class="line">    default: actuator/hystrix.stream     </span><br></pre></td></tr></table></figure>

<p>配置文件注解写的很清楚。</p>
<h2 id="四、Turbine演示"><a href="#四、Turbine演示" class="headerlink" title="四、Turbine演示"></a>四、Turbine演示</h2><p>依次开启eureka-server、service-hi、service-lucy、service-turbine工程。</p>
<p>打开浏览器输入：<a target="_blank" rel="noopener" href="http://localhost:8764/turbine.stream,%E7%95%8C%E9%9D%A2%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:8764/turbine.stream,界面如下：</a></p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc13-1.jpeg" alt="这里写图片描述"></p>
<p>依次请求：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8762/hi?name=forezp">http://localhost:8762/hi?name=forezp</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8763/hi?name=forezp">http://localhost:8763/hi?name=forezp</a></p>
</blockquote>
<p>打开:<a target="_blank" rel="noopener" href="http://localhost:8763/hystrix,%E8%BE%93%E5%85%A5%E7%9B%91%E6%8E%A7%E6%B5%81http://localhost:8764/turbine.stream">http://localhost:8763/hystrix,输入监控流http://localhost:8764/turbine.stream</a></p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc13-2.jpeg" alt="这里写图片描述"></p>
<p>点击monitor stream 进入页面：</p>
<p><img src="https://www.fangzhipeng.com/img/2018/sc13-3.jpeg" alt="这里写图片描述"></p>
<p>可以看到这个页面聚合了2个service的hystrix dashbord数据。</p>
<p>源码下载： <a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter13">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-chapter13</a></p>
<h2 id="五、参考文献"><a href="#五、参考文献" class="headerlink" title="五、参考文献"></a>五、参考文献</h2><p><a target="_blank" rel="noopener" href="http://projects.spring.io/spring-cloud/spring-cloud.html#_circuit_breaker_hystrix_dashboard">hystrix_dashboard</a></p>
<p><a target="_blank" rel="noopener" href="http://projects.spring.io/spring-cloud/spring-cloud.html#_turbine">turbine</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/08/13/sc-f13-turbine.html">https://www.fangzhipeng.com/springcloud/2018/08/13/sc-f13-turbine.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-8"><a href="#Post-Directory-8" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>一、Hystrix Turbine简介</li>
<li>二、准备工作</li>
<li>三、创建service-turbine</li>
<li>四、Turbine演示</li>
<li>五、参考文献</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="14-Spring-Cloud-Gateway-初体验"><a href="#14-Spring-Cloud-Gateway-初体验" class="headerlink" title="14 Spring Cloud Gateway 初体验"></a>14 Spring Cloud Gateway 初体验</h1><p> 2018&#x2F;11&#x2F;06</p>
<p>这篇文章讲述了如何简单地使用Spring Cloud Gateway，来源于Spring Cloud官方案例，地址<a target="_blank" rel="noopener" href="https://spring.io/guides/gs/gateway">https://spring.io/guides/gs/gateway</a> 。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，取代Zuul网关。网关作为流量的，在微服务系统中有着非常作用，网关常见的功能有路由转发、权限校验、限流控制等作用。本文首先用官方的案例带领大家来体验下Spring Cloud的一些简单的功能，在后续文章我会使用详细的案例和源码解析来详细讲解Spring Cloud Gateway.</p>
<h2 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h2><p>本案例的的源码下载于<a target="_blank" rel="noopener" href="https://github.com/spring-guides/gs-gateway.git">官方案例</a>，也可以在我的Github上下载。工程使用的Spring Boot版本为2.0.5.RELEASE，Spring Cloud版本为Finchley.SR1。</p>
<p>新建一个工程，取名为sc-f-gateway-first-sight在工程的pom文件引用工程所需的依赖，包括spring boot和spring cloud，以及gateway的起步依赖spring-cloud-starter-gateway，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;Finchley.SR1&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>** 注：详细的pom文件依赖，可以见源码。**</p>
<h2 id="创建一个简单的路由"><a href="#创建一个简单的路由" class="headerlink" title="创建一个简单的路由"></a>创建一个简单的路由</h2><p>在spring cloud gateway中使用RouteLocator的Bean进行路由转发，将请求进行处理，最后转发到目标的下游服务。在本案例中，会将请求转发到<a href="http://httpbin.org:80这个地址上。代码如下：">http://httpbin.org:80这个地址上。代码如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@RestController</span><br><span class="line">public class Application &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    public RouteLocator myRoutes(RouteLocatorBuilder builder) &#123;</span><br><span class="line">       return builder.routes()</span><br><span class="line">        .route(p -&gt; p</span><br><span class="line">            .path(&quot;/get&quot;)</span><br><span class="line">            .filters(f -&gt; f.addRequestHeader(&quot;Hello&quot;, &quot;World&quot;))</span><br><span class="line">            .uri(&quot;http://httpbin.org:80&quot;))</span><br><span class="line">        .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的myRoutes方法中，使用了一个RouteLocatorBuilder的bean去创建路由，除了创建路由RouteLocatorBuilder可以让你添加各种<strong>predicates</strong>和<strong>filters</strong>，predicates断言的意思，顾名思义就是根据具体的请求的规则，由具体的route去处理，filters是各种过滤器，用来对请求做各种判断和修改。</p>
<p>上面创建的route可以让请求“&#x2F;get”请求都转发到“<a target="_blank" rel="noopener" href="http://httpbin.org/get%E2%80%9D%E3%80%82%E5%9C%A8route%E9%85%8D%E7%BD%AE%E4%B8%8A%EF%BC%8C%E6%88%91%E4%BB%AC%E6%B7%BB%E5%8A%A0%E4%BA%86%E4%B8%80%E4%B8%AAfilter%EF%BC%8C%E8%AF%A5filter%E4%BC%9A%E5%B0%86%E8%AF%B7%E6%B1%82%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAheader,key%E4%B8%BAhello%EF%BC%8Cvalue%E4%B8%BAworld%E3%80%82">http://httpbin.org/get”。在route配置上，我们添加了一个filter，该filter会将请求添加一个header,key为hello，value为world。</a></p>
<p>启动springboot项目，在浏览器上<a target="_blank" rel="noopener" href="http://localhost:8080/get%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%E5%A6%82%E4%B8%8B">http://localhost:8080/get，浏览器显示如下</a>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;, </span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&quot;, </span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;, </span><br><span class="line">    &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, </span><br><span class="line">    &quot;Cache-Control&quot;: &quot;max-age=0&quot;, </span><br><span class="line">    &quot;Connection&quot;: &quot;close&quot;, </span><br><span class="line">    &quot;Cookie&quot;: &quot;_ga=GA1.1.412536205.1526967566; JSESSIONID.667921df=node01oc1cdl4mcjdx1mku2ef1l440q1.node0; screenResolution=1920x1200&quot;, </span><br><span class="line">    &quot;Forwarded&quot;: &quot;proto=http;host=\&quot;localhost:8080\&quot;;for=\&quot;0:0:0:0:0:0:0:1:60036\&quot;&quot;, </span><br><span class="line">    &quot;Hello&quot;: &quot;World&quot;, </span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;, </span><br><span class="line">    &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, </span><br><span class="line">    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;, </span><br><span class="line">    &quot;X-Forwarded-Host&quot;: &quot;localhost:8080&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;origin&quot;: &quot;0:0:0:0:0:0:0:1, 210.22.21.66&quot;, </span><br><span class="line">  &quot;url&quot;: &quot;http://localhost:8080/get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见当我们向gateway工程请求“&#x2F;get”,gateway会将工程的请求转发到“<a target="_blank" rel="noopener" href="http://httpbin.org/get%E2%80%9D%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%9C%A8%E8%BD%AC%E5%8F%91%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%8A%A0%E4%B8%8A%E4%B8%80%E4%B8%AAfilter%EF%BC%8C%E8%AF%A5filter%E4%BC%9A%E5%B0%86%E8%AF%B7%E6%B1%82%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAheader,key%E4%B8%BAhello%EF%BC%8Cvalue%E4%B8%BAworld%E3%80%82">http://httpbin.org/get”，并且在转发之前，加上一个filter，该filter会将请求添加一个header,key为hello，value为world。</a></p>
<p>注意HTTPBin展示了请求的header hello和值world。</p>
<h2 id="使用Hystrix"><a href="#使用Hystrix" class="headerlink" title="使用Hystrix"></a>使用Hystrix</h2><p>在spring cloud gateway中可以使用Hystrix。Hystrix是 spring cloud中一个服务熔断降级的组件，在微服务系统有着十分重要的作用。 Hystrix是 spring cloud gateway中是以filter的形式使用的，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"> public RouteLocator myRoutes(RouteLocatorBuilder builder) &#123;</span><br><span class="line">     String httpUri = &quot;http://httpbin.org:80&quot;;</span><br><span class="line">     return builder.routes()</span><br><span class="line">         .route(p -&gt; p</span><br><span class="line">             .path(&quot;/get&quot;)</span><br><span class="line">             .filters(f -&gt; f.addRequestHeader(&quot;Hello&quot;, &quot;World&quot;))</span><br><span class="line">             .uri(httpUri))</span><br><span class="line">         .route(p -&gt; p</span><br><span class="line">             .host(&quot;*.hystrix.com&quot;)</span><br><span class="line">             .filters(f -&gt; f</span><br><span class="line">                 .hystrix(config -&gt; config</span><br><span class="line">                     .setName(&quot;mycmd&quot;)</span><br><span class="line">                     .setFallbackUri(&quot;forward:/fallback&quot;)))</span><br><span class="line">             .uri(httpUri))</span><br><span class="line">         .build();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们使用了另外一个router，该router使用host去断言请求是否进入该路由，当请求的host有“*.hystrix.com”，都会进入该router，该router中有一个hystrix的filter,该filter可以配置名称、和指向性fallback的逻辑的地址，比如本案例中重定向到了“&#x2F;fallback”。</p>
<p>现在写的一个“&#x2F;fallback”的l逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/fallback&quot;)</span><br><span class="line">   public Mono&lt;String&gt; fallback() &#123;</span><br><span class="line">       return Mono.just(&quot;fallback&quot;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>Mono是一个Reactive stream，对外输出一个“fallback”字符串。</p>
<p>使用curl执行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --dump-header - --header &#x27;Host: www.hystrix.com&#x27; http://localhost:8080/delay/3</span><br></pre></td></tr></table></figure>

<p>返回的响应为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fallback</span><br></pre></td></tr></table></figure>

<p>可见，带host<a target="_blank" rel="noopener" href="http://www.hystrix.com的请求执行了hystrix的fallback的逻辑./">www.hystrix.com的请求执行了hystrix的fallback的逻辑。</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文通过官方的一个简单的案例，来讲解了spring cloud gateway的简单用法，在spring cloud gateway中有2个重要的概念<strong>predicates</strong>和<strong>filters</strong>，它们个将会在后续文章讲解。敬请期待。</p>
<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-first-sight">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-first-sight</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/11/06/sc-f-gateway1.html">https://www.fangzhipeng.com/springcloud/2018/11/06/sc-f-gateway1.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-9"><a href="#Post-Directory-9" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>简介</li>
<li>创建工程</li>
<li>创建一个简单的路由</li>
<li>使用Hystrix</li>
<li>总结</li>
<li>源码下载</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="Spring-Cloud-Gateway-之Predict篇"><a href="#Spring-Cloud-Gateway-之Predict篇" class="headerlink" title="Spring Cloud Gateway 之Predict篇"></a>Spring Cloud Gateway 之Predict篇</h1><p> 2018&#x2F;12&#x2F;05</p>
<h2 id="Spring-Cloud-gateway工作流程"><a href="#Spring-Cloud-gateway工作流程" class="headerlink" title="Spring Cloud gateway工作流程"></a>Spring Cloud gateway工作流程</h2><p>在之前的文章的Spring Cloud Gateway初体验中，大家已经对Spring Cloud Gateway的功能有一个初步的认识，网关作为一个系统的流量的入口，有着举足轻重的作用，通常的作用如下：</p>
<ul>
<li>协议转换，路由转发</li>
<li>流量聚合，对流量进行监控，日志输出</li>
<li>作为整个系统的前端工程，对流量进行控制，有限流的作用</li>
<li>作为系统的前端边界，外部流量只能通过网关才能访问系统</li>
<li>可以在网关层做权限的判断</li>
<li>可以在网关层做缓存</li>
</ul>
<p>Spring Cloud Gateway作为Spring Cloud框架的第二代网关，在功能上要比Zuul更加的强大，性能也更好。随着Spring Cloud的版本迭代，Spring Cloud官方有打算弃用Zuul的意思。在笔者调用了Spring Cloud Gateway的使用和功能上，Spring Cloud Gateway替换掉Zuul的成本上是非常低的，几乎可以无缝切换。Spring Cloud Gateway几乎包含了zuul的所有功能。</p>
<p><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png" alt="img"></p>
<p><strong>注：该图片来自官网</strong></p>
<p>如上图所示，客户端向Spring Cloud Gateway发出请求。 如果Gateway Handler Mapping确定请求与路由匹配（这个时候就用到predicate），则将其发送到Gateway web handler处理。 Gateway web handler处理请求时会经过一系列的过滤器链。 过滤器链被虚线划分的原因是过滤器链可以在发送代理请求之前或之后执行过滤逻辑。 先执行所有“pre”过滤器逻辑，然后进行代理请求。 在发出代理请求之后，收到代理服务的响应之后执行“post”过滤器逻辑。这跟zuul的处理过程很类似。在执行所有“pre”过滤器逻辑时，往往进行了鉴权、限流、日志输出等功能，以及请求头的更改、协议的转换；转发之后收到响应之后，会执行所有“post”过滤器的逻辑，在这里可以响应数据进行了修改，比如响应头、协议的转换等。</p>
<p>在上面的处理过程中，有一个重要的点就是讲请求和路由进行匹配，这时候就需要用到predicate，它是决定了一个请求走哪一个路由。</p>
<h2 id="predicate简介"><a href="#predicate简介" class="headerlink" title="predicate简介"></a>predicate简介</h2><blockquote>
<p>Predicate来自于java8的接口。Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将Predicate组合成其他复杂的逻辑（比如：与，或，非）。可以用于接口请求参数校验、判断新老数据是否有变化需要进行更新操作。add–与、or–或、negate–非。</p>
</blockquote>
<p>Spring Cloud Gateway内置了许多Predict,这些Predict的源码在org.springframework.cloud.gateway.handler.predicate包中，如果读者有兴趣可以阅读一下。现在列举各种Predicate如下图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/12191355-7c74ff861a209cd9.png" alt="img"></p>
<p><strong>注：图片来自网络</strong></p>
<p>在上图中，有很多类型的Predicate,比如说时间类型的Predicated（AfterRoutePredicateFactory BeforeRoutePredicateFactory BetweenRoutePredicateFactory），当只有满足特定时间要求的请求会进入到此predicate中，并交由router处理；cookie类型的CookieRoutePredicateFactory，指定的cookie满足正则匹配，才会进入此router;以及host、method、path、querparam、remoteaddr类型的predicate，每一种predicate都会对当前的客户端请求进行判断，是否满足当前的要求，如果满足则交给当前请求处理。如果有很多个Predicate，并且一个请求满足多个Predicate，则按照配置的顺序第一个生效。</p>
<h2 id="predicate实战"><a href="#predicate实战" class="headerlink" title="predicate实战"></a>predicate实战</h2><p>现在以案例的形式来讲解predicate，本文中的案例基本来源于官方文档，官方文档地址：<a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html">http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html</a> ；如果有任何问题欢迎和我联系，和我讨论。</p>
<p>创建一个工程，在工程的pom文件引入spring cloud gateway 的起步依赖spring-cloud-starter-gateway，spring cloud版本和spring boot版本，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> &lt;parent&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;</span><br><span class="line">  &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependencyManagement&gt;</span><br><span class="line">      &lt;dependencies&gt;</span><br><span class="line">          &lt;dependency&gt;</span><br><span class="line">              &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">              &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">              &lt;version&gt;Finchley.SR1&lt;/version&gt;</span><br><span class="line">              &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">              &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">          &lt;/dependency&gt;</span><br><span class="line">      &lt;/dependencies&gt;</span><br><span class="line">  &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="After-Route-Predicate-Factory"><a href="#After-Route-Predicate-Factory" class="headerlink" title="After Route Predicate Factory"></a>After Route Predicate Factory</h3><p>AfterRoutePredicateFactory，可配置一个时间，当请求的时间在配置时间之后，才交给 router去处理。否则则报错，不通过路由。</p>
<p>在工程的application.yml配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: after_route</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: after_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br><span class="line">  profiles: after_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置文件中，配置了服务的端口为8081，配置spring.profiles.active:after_route指定了程序的spring的启动文件为after_route文件。在application.yml再建一个配置文件，语法是三个横线，在此配置文件中通过spring.profiles来配置文件名，和spring.profiles.active一致，然后配置spring cloud gateway 相关的配置，id标签配置的是router的id，每个router都需要一个唯一的id，uri配置的是将请求路由到哪里，本案例全部路由到<a target="_blank" rel="noopener" href="http://httpbin.org/get%E3%80%82">http://httpbin.org:80/get。</a></p>
<p>predicates： After&#x3D;2017-01-20T17:42:47.789-07:00[America&#x2F;Denver] 会被解析成PredicateDefinition对象 （name &#x3D;After ，args&#x3D; 2017-01-20T17:42:47.789-07:00[America&#x2F;Denver]）。在这里需要注意的是predicates的After这个配置，遵循的契约大于配置的思想，它实际被AfterRoutePredicateFactory这个类所处理，这个After就是指定了它的Gateway web handler类为AfterRoutePredicateFactory，同理，其他类型的predicate也遵循这个规则。</p>
<p>当请求的时间在这个配置的时间之后，请求会被路由到<a target="_blank" rel="noopener" href="http://httpbin.org/get%E3%80%82">http://httpbin.org:80/get。</a></p>
<p>启动工程，在浏览器上访问<a target="_blank" rel="noopener" href="http://localhost:8081/%EF%BC%8C%E4%BC%9A%E6%98%BE%E7%A4%BAhttp://httpbin.org:80/get%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8C%E6%AD%A4%E6%97%B6gateway%E8%B7%AF%E7%94%B1%E5%88%B0%E4%BA%86%E9%85%8D%E7%BD%AE%E7%9A%84uri%E3%80%82%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%B0%86%E9%85%8D%E7%BD%AE%E7%9A%84%E6%97%B6%E9%97%B4%E8%AE%BE%E7%BD%AE%E5%88%B0%E5%BD%93%E5%89%8D%E6%97%B6%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%9A%E6%98%BE%E7%A4%BA404%EF%BC%8C%E6%AD%A4%E6%97%B6%E8%AF%81%E6%98%8E%E6%B2%A1%E6%9C%89%E8%B7%AF%E7%94%B1%E5%88%B0%E9%85%8D%E7%BD%AE%E7%9A%84uri">http://localhost:8081/，会显示http://httpbin.org:80/get返回的结果，此时gateway路由到了配置的uri。如果我们将配置的时间设置到当前时之后，浏览器会显示404，此时证明没有路由到配置的uri</a>.</p>
<p>跟时间相关的predicates还有Before Route Predicate Factory、Between Route Predicate Factory，读者可以自行查阅官方文档，再次不再演示。</p>
<h3 id="Header-Route-Predicate-Factory"><a href="#Header-Route-Predicate-Factory" class="headerlink" title="Header Route Predicate Factory"></a>Header Route Predicate Factory</h3><p>Header Route Predicate Factory需要2个参数，一个是header名，另外一个header值，该值可以是一个正则表达式。当此断言匹配了请求的header名和值时，断言通过，进入到router的规则中去。</p>
<p>在工程的配置文件加上以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: header_route</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: header_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Header=X-Request-Id, \d+</span><br><span class="line">  profiles: header_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，当请求的Header中有X-Request-Id的header名，且header值为数字时，请求会被路由到配置的 uri. 使用curl执行以下命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H &#x27;X-Request-Id:1&#x27; localhost:8081</span><br></pre></td></tr></table></figure>

<p>执行命令后，会正确的返回请求结果，结果省略。如果在请求中没有带上X-Request-Id的header名，并且值不为数字时，请求就会报404，路由没有被正确转发。</p>
<h3 id="Cookie-Route-Predicate-Factory"><a href="#Cookie-Route-Predicate-Factory" class="headerlink" title="Cookie Route Predicate Factory"></a>Cookie Route Predicate Factory</h3><p>Cookie Route Predicate Factory需要2个参数，一个时cookie名字，另一个时值，可以为正则表达式。它用于匹配请求中，带有该名称的cookie和cookie匹配正则表达式的请求。</p>
<p>在配置文件添加以下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: cookie_route</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: cookie_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Cookie=name, forezp</span><br><span class="line">  profiles: cookie_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，请求带有cookie名为 name, cookie值为forezp 的请求将都会转发到uri为 <a target="_blank" rel="noopener" href="http://httpbin.org/get%E7%9A%84%E5%9C%B0%E5%9D%80%E4%B8%8A%E3%80%82">http://httpbin.org:80/get的地址上。</a> 使用curl命令进行请求，在请求中带上 cookie，会返回正确的结果，否则，请求报404错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H &#x27;Cookie:name=forezp&#x27; localhost:8081</span><br></pre></td></tr></table></figure>

<h3 id="Host-Route-Predicate-Factory"><a href="#Host-Route-Predicate-Factory" class="headerlink" title="Host Route Predicate Factory"></a>Host Route Predicate Factory</h3><p>Host Route Predicate Factory需要一个参数即hostname，它可以使用. * 等去匹配host。这个参数会匹配请求头中的host的值，一致，则请求正确转发。</p>
<p>在工程的配置文件，加上以下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: host_route</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: host_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Host=**.fangzhipeng.com</span><br><span class="line">  profiles: host_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，请求头中含有Host为fangzhipeng.com的请求将会被路由转发转发到配置的uri。 启动工程，执行以下的curl命令，请求会返回正确的请求结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;Host:www.fangzhipeng.com&#x27; localhost:8081</span><br></pre></td></tr></table></figure>

<h3 id="Method-Route-Predicate-Factory"><a href="#Method-Route-Predicate-Factory" class="headerlink" title="Method Route Predicate Factory"></a>Method Route Predicate Factory</h3><p>Method Route Predicate Factory 需要一个参数，即请求的类型。比如GET类型的请求都转发到此路由。在工程的配置文件加上以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: method_route</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: method_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Method=GET</span><br><span class="line">  profiles: method_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，所有的GET类型的请求都会路由转发到配置的uri。使用 curl命令模拟 get类型的请求，会得到正确的返回结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:8081</span><br></pre></td></tr></table></figure>

<p>使用 curl命令模拟 post请求，则返回404结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:8081</span><br></pre></td></tr></table></figure>

<h3 id="Path-Route-Predicate-Factory"><a href="#Path-Route-Predicate-Factory" class="headerlink" title="Path Route Predicate Factory"></a>Path Route Predicate Factory</h3><p>Path Route Predicate Factory 需要一个参数: 一个spel表达式，应用匹配路径。</p>
<p>在工程的配置文件application.yml文件中，做以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: path_route</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: path_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/foo/&#123;segment&#125;</span><br><span class="line">  profiles: path_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，所有的请求路径满足&#x2F;foo&#x2F;{segment}的请求将会匹配并被路由，比如&#x2F;foo&#x2F;1 、&#x2F;foo&#x2F;bar的请求，将会命中匹配，并成功转发。</p>
<p>使用curl模拟一个请求localhost:8081&#x2F;foo&#x2F;dew，执行之后会返回正确的请求结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:8081/foo/dew</span><br></pre></td></tr></table></figure>

<h3 id="Query-Route-Predicate-Factory"><a href="#Query-Route-Predicate-Factory" class="headerlink" title="Query Route Predicate Factory"></a>Query Route Predicate Factory</h3><p>Query Route Predicate Factory 需要2个参数:一个参数名和一个参数值的正则表达式。在工程的配置文件application.yml做以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: query_route</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: query_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Query=foo, ba.</span><br><span class="line">  profiles: query_route</span><br></pre></td></tr></table></figure>

<p>在上面的配置文件中，配置了请求中含有参数foo，并且foo的值匹配ba.，则请求命中路由，比如一个请求中含有参数名为foo，值的为bar，能够被正确路由转发。</p>
<p>模拟请求的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:8081?foo=bar</span><br></pre></td></tr></table></figure>

<p>Query Route Predicate Factory也可以只填一个参数，填一个参数时，则只匹配参数名，即请求的参数中含有配置的参数名，则命中路由。比如以下的配置中，配置了请求参数中含有参数名为foo 的参数将会被请求转发到uri为<a target="_blank" rel="noopener" href="http://httpbin.org/get%E3%80%82">http://httpbin.org:80/get。</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: query_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - Query=foo</span><br><span class="line">  profiles: query_route</span><br></pre></td></tr></table></figure>

<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>在本篇文章中，首先介绍了Spring Cloud Gateway的工作流程和原理，然后介绍了gateway框架内置的predict及其分类，最后以案例的形式重点讲解了几个重要的Predict。Predict作为断言，它决定了请求会被路由到哪个router 中。在断言之后，请求会被进入到filter过滤器的逻辑，下篇文章将会为大家介绍Spring Cloud Gateway过滤器相关的内容。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html">http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/35b60946b8ce">https://www.jianshu.com/p/35b60946b8ce</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/03d42105f81f">https://www.jianshu.com/p/03d42105f81f</a></p>
<h2 id="源码下载-1"><a href="#源码下载-1" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-predicate">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-predicate</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/12/05/sc-f-gateway2.html">https://www.fangzhipeng.com/springcloud/2018/12/05/sc-f-gateway2.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-10"><a href="#Post-Directory-10" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li><p>Spring Cloud gateway工作流程</p>
</li>
<li><p>predicate简介</p>
</li>
<li><p>predicate实战</p>
<ul>
<li><p>After Route Predicate Factory</p>
</li>
<li><p>Header Route Predicate Factory</p>
</li>
<li><p>Cookie Route Predicate Factory</p>
</li>
<li><p>Host Route Predicate Factory</p>
</li>
<li><p>Method Route Predicate Factory</p>
</li>
<li><p>Path Route Predicate Factory</p>
</li>
<li><p>Query Route Predicate Factory</p>
</li>
</ul>
</li>
<li><p>总结</p>
</li>
<li><p>参考资料</p>
</li>
<li><p>源码下载</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="spring-cloud-gateway之filter篇"><a href="#spring-cloud-gateway之filter篇" class="headerlink" title="spring cloud gateway之filter篇"></a>spring cloud gateway之filter篇</h1><p> 2018&#x2F;12&#x2F;21</p>
<p>在上一篇文章详细的介绍了Gateway的Predict，Predict决定了请求由哪一个路由处理，在路由处理之前，需要经过“pre”类型的过滤器处理，处理返回响应之后，可以由“post”类型的过滤器处理。</p>
<h2 id="filter的作用和生命周期"><a href="#filter的作用和生命周期" class="headerlink" title="filter的作用和生命周期"></a>filter的作用和生命周期</h2><p>由filter工作流程点，可以知道filter有着非常重要的作用，在“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等，在“post”类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流量监控等。首先需要弄清一点为什么需要网关这一层，这就不得不说下filter的作用了。</p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>当我们有很多个服务时，比如下图中的user-service、goods-service、sales-service等服务，客户端请求各个服务的Api时，每个服务都需要做相同的事情，比如鉴权、限流、日志输出等。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-1ad11b98829e33e5.png" alt="1.png"></p>
<p>对于这样重复的工作，有没有办法做的更好，答案是肯定的。在微服务的上一层加一个全局的权限控制、限流、日志输出的Api Gatewat服务，然后再将请求转发到具体的业务服务层。这个Api Gateway服务就是起到一个服务边界的作用，外接的请求访问系统，必须先通过网关层。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-8aef2be1eccab3d8.png" alt="2.png"></p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>Spring Cloud Gateway同zuul类似，有“pre”和“post”两种方式的filter。客户端的请求先经过“pre”类型的filter，然后将请求转发到具体的业务服务，比如上图中的user-service，收到业务服务的响应之后，再经过“post”类型的filter处理，最后返回响应到客户端。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-16242cf54a5b82e8.png" alt="3.png"></p>
<p>与zuul不同的是，filter除了分为“pre”和“post”两种方式的filter外，在Spring Cloud Gateway中，filter从作用范围可分为另外两种，一种是针对于单个路由的gateway filter，它在配置文件中的写法同predict类似；另外一种是针对于所有路由的global gateway filer。现在从作用范围划分的维度来讲解这两种filter。</p>
<h2 id="gateway-filter"><a href="#gateway-filter" class="headerlink" title="gateway filter"></a>gateway filter</h2><p>过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。过滤器可以限定作用在某些特定请求路径上。 Spring Cloud Gateway包含许多内置的GatewayFilter工厂。</p>
<p>GatewayFilter工厂同上一篇介绍的Predicate工厂类似，都是在配置文件application.yml中配置，遵循了约定大于配置的思想，只需要在配置文件配置GatewayFilter Factory的名称，而不需要写全部的类名，比如AddRequestHeaderGatewayFilterFactory只需要在配置文件中写AddRequestHeader，而不是全部类名。在配置文件中配置的GatewayFilter Factory最终都会相应的过滤器工厂类处理。</p>
<p>Spring Cloud Gateway 内置的过滤器工厂一览表如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-21f95f970275e70f.png" alt="1.png"></p>
<p>现在挑几个常见的过滤器工厂来讲解，每一个过滤器工厂在官方文档都给出了详细的使用案例，如果不清楚的还可以在org.springframework.cloud.gateway.filter.factory看每一个过滤器工厂的源码。</p>
<h3 id="AddRequestHeader-GatewayFilter-Factory"><a href="#AddRequestHeader-GatewayFilter-Factory" class="headerlink" title="AddRequestHeader GatewayFilter Factory"></a>AddRequestHeader GatewayFilter Factory</h3><p>创建工程，引入相关的依赖,包括spring boot 版本2.0.5，spring Cloud版本Finchley，gateway依赖如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在工程的配置文件中，加入以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: add_request_header_route</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: add_request_header_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        filters:</span><br><span class="line">        - AddRequestHeader=X-Request-Foo, Bar</span><br><span class="line">        predicates:</span><br><span class="line">        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br><span class="line">  profiles: add_request_header_route</span><br></pre></td></tr></table></figure>

<p>在上述的配置中，工程的启动端口为8081，配置文件为add_request_header_route，在add_request_header_route配置中，配置了roter的id为add_request_header_route，路由地址为<a target="_blank" rel="noopener" href="http://httpbin.org/get%EF%BC%8C%E8%AF%A5router%E6%9C%89AfterPredictFactory%EF%BC%8C%E6%9C%89%E4%B8%80%E4%B8%AAfilter%E4%B8%BAAddRequestHeaderGatewayFilterFactory(%E7%BA%A6%E5%AE%9A%E5%86%99%E6%88%90AddRequestHeader)%EF%BC%8CAddRequestHeader%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82%E4%BC%9A%E5%9C%A8%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%8A%A0%E4%B8%8A%E4%B8%80%E5%AF%B9%E8%AF%B7%E6%B1%82%E5%A4%B4%EF%BC%8C%E5%90%8D%E7%A7%B0%E4%B8%BAX-Request-Foo%EF%BC%8C%E5%80%BC%E4%B8%BABar%E3%80%82%E4%B8%BA%E4%BA%86%E9%AA%8C%E8%AF%81AddRequestHeaderGatewayFilterFactory%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AE%83%E7%9A%84%E6%BA%90%E7%A0%81%EF%BC%8CAddRequestHeaderGatewayFilterFactory%E7%9A%84%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A">http://httpbin.org:80/get，该router有AfterPredictFactory，有一个filter为AddRequestHeaderGatewayFilterFactory(约定写成AddRequestHeader)，AddRequestHeader过滤器工厂会在请求头加上一对请求头，名称为X-Request-Foo，值为Bar。为了验证AddRequestHeaderGatewayFilterFactory是怎么样工作的，查看它的源码，AddRequestHeaderGatewayFilterFactory的源码如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class AddRequestHeaderGatewayFilterFactory extends AbstractNameValueGatewayFilterFactory &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public GatewayFilter apply(NameValueConfig config) &#123;</span><br><span class="line">		return (exchange, chain) -&gt; &#123;</span><br><span class="line">			ServerHttpRequest request = exchange.getRequest().mutate()</span><br><span class="line">					.header(config.getName(), config.getValue())</span><br><span class="line">					.build();</span><br><span class="line"></span><br><span class="line">			return chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">		&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面的代码可知，根据旧的ServerHttpRequest创建新的 ServerHttpRequest ，在新的ServerHttpRequest加了一个请求头，然后创建新的 ServerWebExchange ，提交过滤器链继续过滤。</p>
<p>启动工程，通过curl命令来模拟请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8081</span><br></pre></td></tr></table></figure>

<p>最终显示了从 <a target="_blank" rel="noopener" href="http://httpbin.org/get%E5%BE%97%E5%88%B0%E4%BA%86%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%93%8D%E5%BA%94%E5%A6%82%E4%B8%8B%EF%BC%9A">http://httpbin.org:80/get得到了请求，响应如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;*/*&quot;,</span><br><span class="line">    &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">    &quot;Forwarded&quot;: &quot;proto=http;host=\&quot;localhost:8081\&quot;;for=\&quot;0:0:0:0:0:0:0:1:56248\&quot;&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;curl/7.58.0&quot;,</span><br><span class="line">    &quot;X-Forwarded-Host&quot;: &quot;localhost:8081&quot;,</span><br><span class="line">    &quot;X-Request-Foo&quot;: &quot;Bar&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;0:0:0:0:0:0:0:1, 210.22.21.66&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http://localhost:8081/get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以上面的响应可知，确实在请求头中加入了X-Request-Foo这样的一个请求头，在配置文件中配置的AddRequestHeader过滤器工厂生效。</p>
<p>跟AddRequestHeader过滤器工厂类似的还有AddResponseHeader过滤器工厂，在此就不再重复。</p>
<h3 id="RewritePath-GatewayFilter-Factory"><a href="#RewritePath-GatewayFilter-Factory" class="headerlink" title="RewritePath GatewayFilter Factory"></a>RewritePath GatewayFilter Factory</h3><p>在Nginx服务启中有一个非常强大的功能就是重写路径，Spring Cloud Gateway默认也提供了这样的功能，这个功能是Zuul没有的。在配置文件中加上以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: rewritepath_route</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: rewritepath_route</span><br><span class="line">        uri: https://blog.csdn.net</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/foo/**</span><br><span class="line">        filters:</span><br><span class="line">        - RewritePath=/foo/(?&lt;segment&gt;.*), /$\&#123;segment&#125;</span><br><span class="line">  profiles: rewritepath_route</span><br></pre></td></tr></table></figure>

<p>上面的配置中，所有的&#x2F;foo&#x2F;*<em>开始的路径都会命中配置的router，并执行过滤器的逻辑，在本案例中配置了RewritePath过滤器工厂，此工厂将&#x2F;foo&#x2F;(?.</em>)重写为{segment}，然后转发到<a target="_blank" rel="noopener" href="https://blog.csdn.net.比如在网页上请求localhost:8081/foo/forezp%EF%BC%8C%E6%AD%A4%E6%97%B6%E4%BC%9A%E5%B0%86%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91%E5%88%B0https://blog.csdn.net/forezp%E7%9A%84%E9%A1%B5%E9%9D%A2%EF%BC%8C%E6%AF%94%E5%A6%82%E5%9C%A8%E7%BD%91%E9%A1%B5%E4%B8%8A%E8%AF%B7%E6%B1%82localhost:8081/foo/forezp/1%EF%BC%8C%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA404%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%9B%A0%E4%B8%BA%E4%B8%8D%E5%AD%98%E5%9C%A8https://blog.csdn.net/forezp/1%E8%BF%99%E4%B8%AA%E9%A1%B5%E9%9D%A2%E3%80%82">https://blog.csdn.net。比如在网页上请求localhost:8081/foo/forezp，此时会将请求转发到https://blog.csdn.net/forezp的页面，比如在网页上请求localhost:8081/foo/forezp/1，页面显示404，就是因为不存在https://blog.csdn.net/forezp/1这个页面。</a></p>
<h3 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h3><p>Spring Cloud Gateway内置了19种强大的过滤器工厂，能够满足很多场景的需求，那么能不能自定义自己的过滤器呢，当然是可以的。在spring Cloud Gateway中，过滤器需要实现GatewayFilter和Ordered2个接口。写一个RequestTimeFilter，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class RequestTimeFilter implements GatewayFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    private static final Log log = LogFactory.getLog(GatewayFilter.class);</span><br><span class="line">    private static final String REQUEST_TIME_BEGIN = &quot;requestTimeBegin&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line"></span><br><span class="line">        exchange.getAttributes().put(REQUEST_TIME_BEGIN, System.currentTimeMillis());</span><br><span class="line">        return chain.filter(exchange).then(</span><br><span class="line">                Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    Long startTime = exchange.getAttribute(REQUEST_TIME_BEGIN);</span><br><span class="line">                    if (startTime != null) &#123;</span><br><span class="line">                        log.info(exchange.getRequest().getURI().getRawPath() + &quot;: &quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，Ordered中的int getOrder()方法是来给过滤器设定优先级别的，值越大则优先级越低。还有有一个filterI(exchange,chain)方法，在该方法中，先记录了请求的开始时间，并保存在ServerWebExchange中，此处是一个“pre”类型的过滤器，然后再chain.filter的内部类中的run()方法中相当于”post”过滤器，在此处打印了请求所消耗的时间。然后将该过滤器注册到router中，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public RouteLocator customerRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class="line">    // @formatter:off</span><br><span class="line">    return builder.routes()</span><br><span class="line">            .route(r -&gt; r.path(&quot;/customer/**&quot;)</span><br><span class="line">                    .filters(f -&gt; f.filter(new RequestTimeFilter())</span><br><span class="line">                            .addResponseHeader(&quot;X-Response-Default-Foo&quot;, &quot;Default-Bar&quot;))</span><br><span class="line">                    .uri(&quot;http://httpbin.org:80/get&quot;)</span><br><span class="line">                    .order(0)</span><br><span class="line">                    .id(&quot;customer_filter_router&quot;)</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">    // @formatter:on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启程序，通过curl命令模拟请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8081/customer/123</span><br></pre></td></tr></table></figure>

<p>在程序的控制台输出一下的请求信息的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-11-16 15:02:20.177  INFO 20488 --- [ctor-http-nio-3] o.s.cloud.gateway.filter.GatewayFilter   : /customer/123: 152ms</span><br></pre></td></tr></table></figure>

<h2 id="自定义过滤器工厂"><a href="#自定义过滤器工厂" class="headerlink" title="自定义过滤器工厂"></a>自定义过滤器工厂</h2><p>在上面的自定义过滤器中，有没有办法自定义过滤器工厂类呢?这样就可以在配置文件中配置过滤器了。现在需要实现一个过滤器工厂，在打印时间的时候，可以设置参数来决定是否打印请参数。查看GatewayFilterFactory的源码，可以发现GatewayFilterfactory的层级如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-f97e1045cebc954c.png" alt="微信截图_20181204175448.png"></p>
<p>过滤器工厂的顶级接口是GatewayFilterFactory，我们可以直接继承它的两个抽象类来简化开发AbstractGatewayFilterFactory和AbstractNameValueGatewayFilterFactory，这两个抽象类的区别就是前者接收一个参数（像StripPrefix和我们创建的这种），后者接收两个参数（像AddResponseHeader）。</p>
<p>过滤器工厂的顶级接口是GatewayFilterFactory，有2个两个较接近具体实现的抽象类，分别为AbstractGatewayFilterFactory和AbstractNameValueGatewayFilterFactory，这2个类前者接收一个参数，比如它的实现类RedirectToGatewayFilterFactory；后者接收2个参数，比如它的实现类AddRequestHeaderGatewayFilterFactory类。现在需要将请求的日志打印出来，需要使用一个参数，这时可以参照RedirectToGatewayFilterFactory的写法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public class RequestTimeGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;RequestTimeGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static final Log log = LogFactory.getLog(GatewayFilter.class);</span><br><span class="line">    private static final String REQUEST_TIME_BEGIN = &quot;requestTimeBegin&quot;;</span><br><span class="line">    private static final String KEY = &quot;withParams&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">        return Arrays.asList(KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RequestTimeGatewayFilterFactory() &#123;</span><br><span class="line">        super(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public GatewayFilter apply(Config config) &#123;</span><br><span class="line">        return (exchange, chain) -&gt; &#123;</span><br><span class="line">            exchange.getAttributes().put(REQUEST_TIME_BEGIN, System.currentTimeMillis());</span><br><span class="line">            return chain.filter(exchange).then(</span><br><span class="line">                    Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                        Long startTime = exchange.getAttribute(REQUEST_TIME_BEGIN);</span><br><span class="line">                        if (startTime != null) &#123;</span><br><span class="line">                            StringBuilder sb = new StringBuilder(exchange.getRequest().getURI().getRawPath())</span><br><span class="line">                                    .append(&quot;: &quot;)</span><br><span class="line">                                    .append(System.currentTimeMillis() - startTime)</span><br><span class="line">                                    .append(&quot;ms&quot;);</span><br><span class="line">                            if (config.isWithParams()) &#123;</span><br><span class="line">                                sb.append(&quot; params:&quot;).append(exchange.getRequest().getQueryParams());</span><br><span class="line">                            &#125;</span><br><span class="line">                            log.info(sb.toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static class Config &#123;</span><br><span class="line"></span><br><span class="line">        private boolean withParams;</span><br><span class="line"></span><br><span class="line">        public boolean isWithParams() &#123;</span><br><span class="line">            return withParams;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setWithParams(boolean withParams) &#123;</span><br><span class="line">            this.withParams = withParams;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中 apply(Config config)方法内创建了一个GatewayFilter的匿名类，具体的实现逻辑跟之前一样，只不过加了是否打印请求参数的逻辑，而这个逻辑的开关是config.isWithParams()。静态内部类类Config就是为了接收那个boolean类型的参数服务的，里边的变量名可以随意写，但是要重写List shortcutFieldOrder()这个方法。 。</p>
<p>需要注意的是，在类的构造器中一定要调用下父类的构造器把Config类型传过去，否则会报ClassCastException</p>
<p>最后，需要在工程的启动文件Application类中，向Srping Ioc容器注册RequestTimeGatewayFilterFactory类的Bean。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public RequestTimeGatewayFilterFactory elapsedGatewayFilterFactory() &#123;</span><br><span class="line">    return new RequestTimeGatewayFilterFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以在配置文件中配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: elapse_route</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: elapse_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        filters:</span><br><span class="line">        - RequestTime=false</span><br><span class="line">        predicates:</span><br><span class="line">        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br><span class="line">  profiles: elapse_route</span><br></pre></td></tr></table></figure>

<p>启动工程，在浏览器上访问localhost:8081?name&#x3D;forezp，可以在控制台上看到，日志输出了请求消耗的时间和请求参数。</p>
<h2 id="global-filter"><a href="#global-filter" class="headerlink" title="global filter"></a>global filter</h2><p>Spring Cloud Gateway根据作用范围划分为GatewayFilter和GlobalFilter，二者区别如下：</p>
<ul>
<li>GatewayFilter : 需要通过spring.cloud.routes.filters 配置在具体路由下，只作用在当前路由上或通过spring.cloud.default-filters配置在全局，作用在所有路由上</li>
<li>GlobalFilter : 全局过滤器，不需要在配置文件中配置，作用在所有的路由上，最终通过GatewayFilterAdapter包装成GatewayFilterChain可识别的过滤器，它为请求业务以及路由的URI转换为真实业务服务的请求地址的核心过滤器，不需要配置，系统初始化时加载，并作用在每个路由上。</li>
</ul>
<p>Spring Cloud Gateway框架内置的GlobalFilter如下：</p>
<p><img src="https://raw.githubusercontent.com/guofazhan/image/master/GlobalFilter.png" alt="img"></p>
<p>上图中每一个GlobalFilter都作用在每一个router上，能够满足大多数的需求。但是如果遇到业务上的定制，可能需要编写满足自己需求的GlobalFilter。在下面的案例中将讲述如何编写自己GlobalFilter，该GlobalFilter会校验请求中是否包含了请求参数“token”，如何不包含请求参数“token”则不转发路由，否则执行正常的逻辑。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class TokenFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    Logger logger=LoggerFactory.getLogger( TokenFilter.class );</span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(&quot;token&quot;);</span><br><span class="line">        if (token == null || token.isEmpty()) &#123;</span><br><span class="line">            logger.info( &quot;token is empty...&quot; );</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            return exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        return chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return -100;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的TokenFilter需要实现GlobalFilter和Ordered接口，这和实现GatewayFilter很类似。然后根据ServerWebExchange获取ServerHttpRequest，然后根据ServerHttpRequest中是否含有参数token，如果没有则完成请求，终止转发，否则执行正常的逻辑。</p>
<p>然后需要将TokenFilter在工程的启动类中注入到Spring Ioc容器中，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public TokenFilter tokenFilter()&#123;</span><br><span class="line">        return new TokenFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动工程，使用curl命令请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8081/customer/123</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到请没有被转发，请求被终止，并在控制台打印了如下日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-11-16 15:30:13.543  INFO 19372 --- [ctor-http-nio-2] gateway.TokenFilter                      : token is empty...</span><br></pre></td></tr></table></figure>

<p>上面的日志显示了请求进入了没有传“token”的逻辑。</p>
<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>本篇文章讲述了Spring Cloud Gateway中的过滤器，包括GatewayFilter和GlobalFilter。从官方文档的内置过滤器讲起，然后讲解自定义GatewayFilter、GatewayFilterFactory以及自定义的GlobalFilter。有很多内置的过滤器并没有讲述到，比如限流过滤器，这个我觉得是比较重要和大家关注的过滤器，将在之后的文章讲述。</p>
<h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.M1/single/spring-cloud-gateway.html">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.M1/single/spring-cloud-gateway.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb3a67291050">https://www.jianshu.com/p/eb3a67291050</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36236890/article/details/80822051">https://blog.csdn.net/qq_36236890/article/details/80822051</a></p>
<p><a target="_blank" rel="noopener" href="https://windmt.com/2018/05/08/spring-cloud-14-spring-cloud-gateway-filter">https://windmt.com/2018/05/08/spring-cloud-14-spring-cloud-gateway-filter</a></p>
<h2 id="源码下载-2"><a href="#源码下载-2" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-predicate">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-predicate</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/12/21/sc-f-gatway3.html">https://www.fangzhipeng.com/springcloud/2018/12/21/sc-f-gatway3.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-11"><a href="#Post-Directory-11" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li><p>filter的作用和生命周期</p>
<ul>
<li><p>作用</p>
</li>
<li><p>生命周期</p>
</li>
</ul>
</li>
<li><p>gateway filter</p>
<ul>
<li><p>AddRequestHeader GatewayFilter Factory</p>
</li>
<li><p>RewritePath GatewayFilter Factory</p>
</li>
<li><p>自定义过滤器</p>
</li>
</ul>
</li>
<li><p>自定义过滤器工厂</p>
</li>
<li><p>global filter</p>
</li>
<li><p>总结</p>
</li>
<li><p>参考资料</p>
</li>
<li><p>源码下载</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="spring-cloud-gateway-之限流篇"><a href="#spring-cloud-gateway-之限流篇" class="headerlink" title="spring cloud gateway 之限流篇"></a>spring cloud gateway 之限流篇</h1><p> 2018&#x2F;12&#x2F;22</p>
<p>在高并发的系统中，往往需要在系统中做限流，一方面是为了防止大量的请求使服务器过载，导致服务不可用，另一方面是为了防止网络攻击。</p>
<p>常见的限流方式，比如Hystrix适用线程池隔离，超过线程池的负载，走熔断的逻辑。在一般应用服务器中，比如tomcat容器也是通过限制它的线程数来控制并发的；也有通过时间窗口的平均速度来控制流量。常见的限流纬度有比如通过Ip来限流、通过uri来限流、通过用户访问频次来限流。</p>
<p>一般限流都是在网关这一层做，比如Nginx、Openresty、kong、zuul、Spring Cloud Gateway等；也可以在应用层通过Aop这种方式去做限流。</p>
<p>本文详细探讨在 Spring Cloud Gateway 中如何实现限流。</p>
<h2 id="常见的限流算法"><a href="#常见的限流算法" class="headerlink" title="常见的限流算法"></a>常见的限流算法</h2><h3 id="计数器算法"><a href="#计数器算法" class="headerlink" title="计数器算法"></a>计数器算法</h3><p>计数器算法采用计数器实现限流有点简单粗暴，一般我们会限制一秒钟的能够通过的请求数，比如限流qps为100，算法的实现思路就是从第一个请求进来开始计时，在接下去的1s内，每来一个请求，就把计数加1，如果累加的数字达到了100，那么后续的请求就会被全部拒绝。等到1s结束后，把计数恢复成0，重新开始计数。具体的实现可以是这样的：对于每次服务调用，可以通过AtomicLong#incrementAndGet()方法来给计数器加1并返回最新值，通过这个最新值和阈值进行比较。这种实现方式，相信大家都知道有一个弊端：如果我在单位时间1s内的前10ms，已经通过了100个请求，那后面的990ms，只能眼巴巴的把请求拒绝，我们把这种现象称为“突刺现象”</p>
<h3 id="漏桶算法"><a href="#漏桶算法" class="headerlink" title="漏桶算法"></a>漏桶算法</h3><p>漏桶算法为了消除”突刺现象”，可以采用漏桶算法实现限流，漏桶算法这个名字就很形象，算法内部有一个容器，类似生活用到的漏斗，当请求进来时，相当于水倒入漏斗，然后从下端小口慢慢匀速的流出。不管上面流量多大，下面流出的速度始终保持不变。不管服务调用方多么不稳定，通过漏桶算法进行限流，每10毫秒处理一次请求。因为处理的速度是固定的，请求进来的速度是未知的，可能突然进来很多请求，没来得及处理的请求就先放在桶里，既然是个桶，肯定是有容量上限，如果桶满了，那么新进来的请求就丢弃。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/6615987-ae8673111579969f.png" alt="img"></p>
<p>在算法实现方面，可以准备一个队列，用来保存请求，另外通过一个线程池（ScheduledExecutorService）来定期从队列中获取请求并执行，可以一次性获取多个并发执行。</p>
<p>这种算法，在使用过后也存在弊端：无法应对短时间的突发流量。</p>
<h3 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h3><p>从某种意义上讲，令牌桶算法是对漏桶算法的一种改进，桶算法能够限制请求调用的速率，而令牌桶算法能够在限制调用的平均速率的同时还允许一定程度的突发调用。在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。放令牌这个动作是持续不断的进行，如果桶中令牌数达到上限，就丢弃令牌，所以就存在这种情况，桶中一直有大量的可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置qps为100，那么限流器初始化完成一秒后，桶中就已经有100个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求。所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行。</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/6615987-348db0c2328ddee7.png" alt="img"></p>
<p>实现思路：可以准备一个队列，用来保存令牌，另外通过一个线程池定期生成令牌放到队列中，每来一个请求，就从队列中获取一个令牌，并继续执行。</p>
<h2 id="Spring-Cloud-Gateway限流"><a href="#Spring-Cloud-Gateway限流" class="headerlink" title="Spring Cloud Gateway限流"></a>Spring Cloud Gateway限流</h2><p>在Spring Cloud Gateway中，有Filter过滤器，因此可以在“pre”类型的Filter中自行实现上述三种过滤器。但是限流作为网关最基本的功能，Spring Cloud Gateway官方就提供了RequestRateLimiterGatewayFilterFactory这个类，适用Redis和lua脚本实现了令牌桶的方式。具体实现逻辑在RequestRateLimiterGatewayFilterFactory类中，lua脚本在如下图所示的文件夹中：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-1f5070bb28024af9.png" alt="WX20181209-215912@2x.png"></p>
<p>具体源码不打算在这里讲述，读者可以自行查看，代码量较少，先以案例的形式来讲解如何在Spring Cloud Gateway中使用内置的限流过滤器工厂来实现限流。</p>
<p>首先在工程的pom文件中引入gateway的起步依赖和redis的reactive依赖，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifatId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在配置文件中做以下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: limit_route</span><br><span class="line">        uri: http://httpbin.org:80/get</span><br><span class="line">        predicates:</span><br><span class="line">        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br><span class="line">        filters:</span><br><span class="line">        - name: RequestRateLimiter</span><br><span class="line">          args:</span><br><span class="line">            key-resolver: &#x27;#&#123;@hostAddrKeyResolver&#125;&#x27;</span><br><span class="line">            redis-rate-limiter.replenishRate: 1</span><br><span class="line">            redis-rate-limiter.burstCapacity: 3</span><br><span class="line">  application:</span><br><span class="line">    name: gateway-limiter</span><br><span class="line">  redis:</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 6379</span><br><span class="line">    database: 0</span><br></pre></td></tr></table></figure>

<p>在上面的配置文件，指定程序的端口为8081，配置了 redis的信息，并配置了RequestRateLimiter的限流过滤器，该过滤器需要配置三个参数：</p>
<ul>
<li>burstCapacity，令牌桶总容量。</li>
<li>replenishRate，令牌桶每秒填充平均速率。</li>
<li>key-resolver，用于限流的键的解析器的 Bean 对象的名字。它使用 SpEL 表达式根据#{@beanName}从 Spring 容器中获取 Bean 对象。</li>
</ul>
<p>KeyResolver需要实现resolve方法，比如根据Hostname进行限流，则需要用hostAddress去判断。实现完KeyResolver之后，需要将这个类的Bean注册到Ioc容器中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HostAddrKeyResolver implements KeyResolver &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;String&gt; resolve(ServerWebExchange exchange) &#123;</span><br><span class="line">        return Mono.just(exchange.getRequest().getRemoteAddress().getAddress().getHostAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> @Bean</span><br><span class="line">    public HostAddrKeyResolver hostAddrKeyResolver() &#123;</span><br><span class="line">        return new HostAddrKeyResolver();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以根据uri去限流，这时KeyResolver代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class UriKeyResolver  implements KeyResolver &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;String&gt; resolve(ServerWebExchange exchange) &#123;</span><br><span class="line">        return Mono.just(exchange.getRequest().getURI().getPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> @Bean</span><br><span class="line">    public UriKeyResolver uriKeyResolver() &#123;</span><br><span class="line">        return new UriKeyResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>也可以以用户的维度去限流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"> KeyResolver userKeyResolver() &#123;</span><br><span class="line">     return exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst(&quot;user&quot;));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>用jmeter进行压测，配置10thread去循环请求lcoalhost:8081，循环间隔1s。从压测的结果上看到有部分请求通过，由部分请求失败。通过redis客户端去查看redis中存在的key。如下：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-8b25dea450dbd070.png" alt="微信截图_20181205172625.png"></p>
<p>可见，RequestRateLimiter是使用Redis来进行限流的，并在redis中存储了2个key。关注这两个key含义可以看lua源代码。</p>
<h2 id="源码下载-3"><a href="#源码下载-3" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-limiter">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-limiter</a></p>
<h2 id="参考资料-2"><a href="#参考资料-2" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html#_requestratelimiter_gatewayfilter_factory">http://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.0.0.RELEASE/single/spring-cloud-gateway.html#_requestratelimiter_gatewayfilter_factory</a></p>
<p><a target="_blank" rel="noopener" href="https://windmt.com/2018/05/09/spring-cloud-15-spring-cloud-gateway-ratelimiter/">https://windmt.com/2018/05/09/spring-cloud-15-spring-cloud-gateway-ratelimiter/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.spring4all.com/article/1382">http://www.spring4all.com/article/1382</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/12/22/sc-f-gatway4.html">https://www.fangzhipeng.com/springcloud/2018/12/22/sc-f-gatway4.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-12"><a href="#Post-Directory-12" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li><p>常见的限流算法</p>
<ul>
<li><p>计数器算法</p>
</li>
<li><p>漏桶算法</p>
</li>
<li><p>令牌桶算法</p>
</li>
</ul>
</li>
<li><p>Spring Cloud Gateway限流</p>
</li>
<li><p>源码下载</p>
</li>
<li><p>参考资料</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>
<h1 id="spring-cloud-gateway之服务注册与发现"><a href="#spring-cloud-gateway之服务注册与发现" class="headerlink" title="spring cloud gateway之服务注册与发现"></a>spring cloud gateway之服务注册与发现</h1><p> 2018&#x2F;12&#x2F;23</p>
<p>在之前的文章介绍了Spring Cloud Gateway的Predict（断言）、Filter（过滤器），大家对Spring Cloud Gateway有初步的认识，其中在对服务路由转发的这一块，在之前的文章是采用硬编码的方式进行路由转发。这篇文章以案例的形式来讲解Spring Cloud Gateway如何配合服务注册中心进行路由转发。</p>
<h2 id="工程介绍"><a href="#工程介绍" class="headerlink" title="工程介绍"></a>工程介绍</h2><p>本案例中使用spring boot的版本为2.0.3.RELEASE,spring cloud版本为Finchley.RELEASE。在中涉及到了三个工程， 分别为注册中心eureka-server、服务提供者service-hi、 服务网关service-gateway，如下：</p>
<table>
<thead>
<tr>
<th align="left">工程名</th>
<th align="left">端口</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">eureka-server</td>
<td align="left">8761</td>
<td align="left">注册中心eureka server</td>
</tr>
<tr>
<td align="left">service-hi</td>
<td align="left">8762</td>
<td align="left">服务提供者 eurka client</td>
</tr>
<tr>
<td align="left">service-gateway</td>
<td align="left">8081</td>
<td align="left">路由网关 eureka client</td>
</tr>
</tbody></table>
<p>这三个工程中，其中service-hi、service-gateway向注册中心eureka-server注册。用户的请求首先经过service-gateway，根据路径由gateway的predict 去断言进到哪一个 router， router经过各种过滤器处理后，最后路由到具体的业务服务，比如 service-hi。如图：</p>
<p><img src="https://www.fangzhipeng.com/img/jianshu/2279594-810c62306e19f084.png" alt="微信截图_20181206163700.png"></p>
<p>eureka-server、service-hi这两个工程直接复制于我的另外一篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/81040925">https://blog.csdn.net/forezp/article/details/81040925</a> ，在这就不在重复，可以查看源码，源码地址见文末链接。 其中，service-hi服务对外暴露了一个RESTFUL接口“&#x2F;hi”接口。现在重点讲解service-gateway。</p>
<h2 id="gateway工程详细介绍"><a href="#gateway工程详细介绍" class="headerlink" title="gateway工程详细介绍"></a>gateway工程详细介绍</h2><p>在gateway工程中引入项目所需的依赖，包括eureka-client的起步依赖和gateway的起步依赖，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在工程的配置文件application.yml中 ，指定程序的启动端口为8081，注册地址、gateway的配置等信息，配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sc-gateway-service</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true</span><br><span class="line">          lowerCaseServiceId: true</span><br><span class="line">          </span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br></pre></td></tr></table></figure>

<p>其中，spring.cloud.gateway.discovery.locator.enabled为true，表明gateway开启服务注册和发现的功能，并且spring cloud gateway自动根据服务发现为每一个服务创建了一个router，这个router将以服务名开头的请求路径转发到对应的服务。spring.cloud.gateway.discovery.locator.lowerCaseServiceId是将请求路径上的服务名配置为小写（因为服务注册的时候，向注册中心注册时将服务名转成大写的了），比如以&#x2F;service-hi&#x2F;*的请求路径被路由转发到服务名为service-hi的服务上。</p>
<p>在浏览器上请求输入localhost:8081&#x2F;service-hi&#x2F;hi?name&#x3D;1323，网页获取以下的响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hi 1323 ,i am from port:8762</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，向gateway-service发送的请求时，url必须带上服务名service-hi这个前缀，才能转发到service-hi上，转发之前会将service-hi去掉。 那么我能不能自定义请求路径呢，毕竟根据服务名有时过于太长，或者历史的原因不能根据服务名去路由，需要由自定义路径并转发到具体的服务上。答案是肯定的是可以的，只需要修改工程的配置文件application.yml，具体配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sc-gateway-server</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: false</span><br><span class="line">          lowerCaseServiceId: true</span><br><span class="line">      routes:</span><br><span class="line">      - id: service-hi</span><br><span class="line">        uri: lb://SERVICE-HI</span><br><span class="line">        predicates:</span><br><span class="line">          - Path=/demo/**</span><br><span class="line">        filters:</span><br><span class="line">          - StripPrefix=1</span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<p>在上面的配置中，配置了一个Path 的predict,将以&#x2F;demo&#x2F;**开头的请求都会转发到uri为lb:&#x2F;&#x2F;SERVICE-HI的地址上，lb:&#x2F;&#x2F;SERVICE-HI即service-hi服务的负载均衡地址，并用StripPrefix的filter 在转发之前将&#x2F;demo去掉。同时将spring.cloud.gateway.discovery.locator.enabled改为false，如果不改的话，之前的localhost:8081&#x2F;service-hi&#x2F;hi?name&#x3D;1323这样的请求地址也能正常访问，因为这时为每个服务创建了2个router。</p>
<p>在浏览器上请求localhost:8081&#x2F;demo&#x2F;hi?name&#x3D;1323，浏览器返回以下的响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hi 1323 ,i am from port:8762</span><br></pre></td></tr></table></figure>

<p>返回的结果跟我们预想的一样。</p>
<h2 id="源码下载-4"><a href="#源码下载-4" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-cloud">https://github.com/forezp/SpringCloudLearning/tree/master/sc-f-gateway-cloud</a></p>
<h2 id="参考资料-3"><a href="#参考资料-3" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5aa4eacbf265da237a4ca36f">https://juejin.im/post/5aa4eacbf265da237a4ca36f</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1c942a8abe18">https://www.jianshu.com/p/1c942a8abe18</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5ba8daa56fb9a05cfe486ebf">https://juejin.im/post/5ba8daa56fb9a05cfe486ebf</a></p>
<blockquote>
<p>本文为原创文章，转载请标明出处。<br>本文链接：<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/springcloud/2018/12/23/sc-f-gateway5.html">https://www.fangzhipeng.com/springcloud/2018/12/23/sc-f-gateway5.html</a><br>本文出自<a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/">方志朋的博客</a></p>
</blockquote>
<p><img src="https://www.fangzhipeng.com/img/avatar.jpg" alt="img"></p>
<p><strong>（转载本站文章请注明作者和出处 <a target="_blank" rel="noopener" href="http://www.fangzhipeng.com/">方志朋-forezp</a>）</strong></p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=avhjl9bq">阿里云ECS云服务器2折起 </a>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/redirect.php?redirect=1032&cps_key=f8d66b5f6d655b87575c252083fca54f&from=console">腾讯云低成本建站方案</a></p>
<h3 id="Post-Directory-13"><a href="#Post-Directory-13" class="headerlink" title="Post Directory"></a>Post Directory</h3><ul>
<li>工程介绍</li>
<li>gateway工程详细介绍</li>
<li>源码下载</li>
<li>参考资料</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">粤ICP备18121138号</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">John Doe</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2022/09/28/springcloud%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/">http://example.com/2022/09/28/springcloud%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">John Doe</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">No tag</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/09/28/vue%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="VUE学习笔记">
                        
                        <span class="card-title">VUE学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-09-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            John Doe
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/09/28/hello-world/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Hello World">
                        
                        <span class="card-title">Hello World</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-09-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            John Doe
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">John Doe</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zcx2842000" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1040058607@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1040058607" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1040058607" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
